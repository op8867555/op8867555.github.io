<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:dc="http://purl.org/dc/elements/1.1/">
    <channel>
        <title>Alex Lu's Blog Feed</title>
        <link>https://op8867555.github.io</link>
        <description><![CDATA[Alex Lu's Blog Feed]]></description>
        <atom:link href="https://op8867555.github.io/feed.xml" rel="self"
                   type="application/rss+xml" />
        <lastBuildDate>Tue, 09 Jan 2018 00:00:00 UT</lastBuildDate>
        <item>
    <title>機器如何計算微分/偏微分（上）</title>
    <link>https://op8867555.github.io/posts/2017-12-17-autodiff.html</link>
    <description><![CDATA[<section>
<p>提到近年來熱門的類神經網路模型，反傳導(back propagation)是一個相當重要的過程，其中應用的就是計算梯度（gradient，就是每個參數的偏微分）修正神經參數來達到「學習」的效果，類神經網路的結構越來越複雜，使得人工推導梯度公式越來越不可行，如何應用電腦計算微分變成了一個重要的問題。</p>
</section>
<div class="fullwidth">
<figure>
<img src="https://i.imgur.com/R5QzZY4.png" alt="這張圖簡單地解釋了計算微分的幾種作法。摘自“Automatic Differentiation of Algorithms for Machine Learning”" /><figcaption>這張圖簡單地解釋了計算微分的幾種作法。摘自“Automatic Differentiation of Algorithms for Machine Learning”</figcaption>
</figure>
</div>
<section id="numerical-differential" class="level1">
<h1>Numerical Differential</h1>
<p><span><label for="sn-1" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="marginnote"> <img src="https://upload.wikimedia.org/wikipedia/commons/1/18/Derivative.svg" /> 數值微分， By Olivier Cleynen (Own work) [CC0], via Wikimedia Commons<br />
<br />
</span></span></p>
<p>數值微分就是用 <span class="math inline">\(\frac{f(x + h) - f(x)}{h}\)</span> 跟一個很小的 <span class="math inline">\(h\)</span> 來<strong>近似</strong> <span class="math inline">\(\lim_{h \rightarrow 0}\frac{f(x + h) - f(x)}{h}\)</span>，實作上也只是計算用不同的參數來計算函數 <span class="math inline">\(f\)</span> 的差異，但是 <span class="math inline">\(f\)</span> 的計算成本可能不低，而且很容易遇到浮點數計算的 round-off error 跟 truncating error，所以實務上並不實用。</p>
<section id="實作" class="level2">
<h2>實作</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="im">from</span> math <span class="im">import</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">def</span> diff(f, x, epilson<span class="op">=</span><span class="fl">0.00001</span>):</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="cf">return</span> (f(x<span class="op">+</span>epilson) <span class="op">-</span> f(x))<span class="op">/</span>epilson</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">diff(sin, pi) <span class="co"># -0.9999999999898844</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">def</span> f(x, y):</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    <span class="cf">return</span> sin(x) <span class="op">+</span> x <span class="op">*</span> y</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># 計算偏微分就是把不關心的參數視為常數</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="im">from</span> functools <span class="im">import</span> partial</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">diff(partial(f, y<span class="op">=</span><span class="dv">2</span>), <span class="dv">3</span>) <span class="co"># 1.0100067978413563 (df(2,3)dx)</span></a></code></pre></div>
</section>
</section>
<section id="symbolic-differential" class="level1">
<h1>Symbolic Differential</h1>
<p>符號微分是符號計算 (Symbolic Computing) 的一個經典例子：不去計算數值，而是 <em>跟人類一樣</em> 直接處理這些符號。<span><label for="sn-2" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-2" class="margin-toggle"/><span class="marginnote"> 我最早是在 SICP 一書看見這個作法，可以忍受很多括號的讀者可以去看一下 <a href="https://mitpress.mit.edu/sicp/full-text/book/book-Z-H-16.html#%_sec_2.3.2">§2.3.2</a> 的介紹。<br />
<br />
</span></span> 在修習微積分課程時，一定會提到如何利用 <a href="https://en.wikipedia.org/wiki/Differentiation_rules">Differentiation rules</a> 來求出導數，像是:</p>
<ul>
<li><span class="math inline">\((a \cdot f)&#39; = af&#39;\)</span></li>
<li><span class="math inline">\((f + g)&#39; = f&#39; + g&#39;\)</span></li>
<li><span class="math inline">\((f(x) \cdot g(x))&#39; = f&#39;(x)g(x) + f(x)g&#39;(x)\)</span></li>
<li><span class="math inline">\((f(g(x)))&#39; = f&#39;(g(x)) g&#39;(x)\)</span></li>
</ul>
<p>而 Symbolic Differential 就是採用跟人類一樣的方法，對著 expression tree 不斷的做 pattern matching 跟 rewrite。這個方法很好實作，只需要照著 Differential rules 改寫便是，而且可以得到<strong>真正的</strong><span><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle"/><span class="sidenote">Exact Derivative，也就是跟手動推導的結果一致，Numerical Differential 因為浮點數的特性，會產生誤差而無法算出真正的導數/偏導數<br />
<br />
</span></span>導數/偏導數。</p>
<p>但是這個方法最大的問題是在改寫的過程中，會出現很多冗於的式子： <span class="math inline">\(x \times 1\)</span>, <span class="math inline">\(x + 0\)</span> 之類的，因此很容易產生出巨大的（沒效率）的結果。<span><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle"/><span class="sidenote">“Automatic Differentiation in Machine Learning: a Survey” 一文中舉例到： <span class="math display">\[f(x) = 64x(1 - x)(1 - 2x)^2(1 - 8x + 8x^2)^2\]</span> 在沒有化簡的情況做符號微分會得到 <span class="math display">\[\begin{gathered}
  128x(1 - x)(-8 + 16x)(1 - 2x)^2(1 - 8x+8x^2) \\
  + 64(1-x)(1-2x)^2 (1-8x+ 8x^2)^2\\
  - 64x(1-2x)^2 (1-8x+8x^2)^2 \\
  - 256x(1 - x)(1 - 2x)(1 - 8x + 8x^2)^2
  \end{gathered} \]</span> 這條很複雜的式子，但是經過化簡則只剩下 <span class="math display">\[\begin{gathered}
  64(1 - 42x + 504x^2 - 2640x^3  \\
  + 7040x^4 -9984x^5 + 7168x^6 -2048x^7)
  \end{gathered}\]</span>，而隨著原式<span class="math inline">\(f\)</span>的複雜度上升，沒做好簡化的符號微分會膨脹非常快。<br />
<br />
</span></span></p>
<p>以 Python 來說，SymPy 就實作了符號積分，可以看到 <code>diff</code> 會產出一個新的運算式。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="im">from</span> sympy <span class="im">import</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">x <span class="op">=</span> var(<span class="st">&#39;x&#39;</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">expr <span class="op">=</span> diff(sin(x)) <span class="co"># cos(x)</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">expr.evalf(subs<span class="op">=</span>{<span class="st">&#39;x&#39;</span>: pi}) <span class="co"># -1.000000000000</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">expr2 <span class="op">=</span> diff(sin(x)<span class="op">+</span> x <span class="op">*</span> y, x)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">expr2.evalf(subs<span class="op">=</span>{<span class="st">&#39;x&#39;</span>: <span class="dv">3</span>, <span class="st">&#39;y&#39;</span>: <span class="dv">2</span>}) <span class="co"># 1.0100075033995546</span></a></code></pre></div>
<!--

左圖為$f(x, y) = sin(x) + x*y$的示意圖，右圖為以符號計算$\frac{df}{dx}$的示意圖：


~~~~
        f(x, y)    |         dfdx
          +-+      |         +-+
          |+|      |         |+|
          +-+      |         +-+
         /  \      |        /  \
        /    \     |       /    \
    +---+     +-+  |   +---+     +-+
    |sin|     |×|  |   |cos|     |0|
    +---+     +-+  |   +---+     +-+
      |       /|   |     |
      | _____/ |   |     |
      |/       |   |     |
     +-+      +-+  |    +-+
     |x|      |y|  |    |x|
     +-+      +-+  |    +-+
~~~~~
-->
</section>
<section id="forward-mode-automatic-differential" class="level1">
<h1>Forward-Mode Automatic Differential</h1>
<p>自動微分（AD）的名稱取得很容易讓人誤解，其實就是應用 chain rule 跟一些語言特性或是原始碼轉換工具，來達成不用手寫導數的程式，而可以在計算函數的同時（也就是 overhead 不大）得出<strong>真正的</strong>導數/偏導數。</p>
<p>自動微分根據計算的順序，可以分為 Forward Mode 跟 Reverse Mode，這次先介紹比較簡單的 Forward Mode。</p>
<p><span><label for="sn-5" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-5" class="margin-toggle"/><span class="marginnote"> Forward Mode AD 將一個函數 <span class="math inline">\(y = f(... , x, ...) = (w_m \circ w_{m-1} ... \circ w_1)(..., x, ...)\)</span> 對 <span class="math inline">\(x\)</span> 的微分，拆解成 <span class="math display">\[
  \begin{aligned}
  \frac {\partial y}{\partial x} =&amp;\frac {\partial y}{\partial w_{m-1}}{\frac {\partial w_{m-1}}{\partial x}} \\
  =&amp;\frac {\partial y}{\partial w_{m-1}}\left({\frac {\partial w_{m-1}}{\partial w_{m-2}}}{\frac {\partial w_{m-2}}{\partial x}}\right) \\
  =&amp;\frac {\partial y}{\partial w_{m-1}}\left({\frac {\partial w_{m-1}}{\partial w_{m-2}}}\left({\frac {\partial w_{m-2}}{\partial w_{m-3}}}{\frac {\partial w_{m-3}}{\partial x}}\right)\right) \\
  =&amp;{\frac {\partial y}{\partial w_{m-1}}} \left( \frac {\partial w_{m-1}}{\partial w_{m-2}} \cdots
  \left(\frac {\partial w_{2}}{\partial w_{1}}  \frac {\partial w_{1}}{\partial x} \right)\right)\\
  \end{aligned}
  \]</span> 然後從 <span class="math inline">\(\frac{\partial x}{\partial x} = 1\)</span> 開始， 由 <span class="math inline">\(\frac{\partial w_1}{\partial x}\)</span> 開始計算到 <span class="math inline">\(\frac{\partial w_m}{x}\)</span>（由內而外）。<br />
<br />
</span></span></p>
<p>這邊繼續使用上面的 <span class="math inline">\(Y = f(x, y) = sin(x) + x × y\)</span> 的例子，</p>
<p>我們可以把 <span class="math inline">\(Y\)</span> 拆解成下圖（左）</p>
<p><span class="math display">\[
\begin{array}{rl|rl}
  Y &amp; =  w_5       &amp; \dot{Y} &amp; = \dot{w_5} \\
w_5 &amp; =  w_3 + w_4 &amp; \dot{w_5} &amp; = \dot{w_3} + \dot{w_4} \\
w_4 &amp; =  w_1 × w_2 &amp; \dot{w_4} &amp; = w_2 × \dot{w_1} + w_1 × \dot{w_2}\\
w_3 &amp; =  sin(w_1)  &amp; \dot{w_3} &amp; = cos(w_1) \\
w_2 &amp; =  y         &amp; \dot{w_2} &amp; = 0\\
w_1 &amp; =  x         &amp; \dot{w_1} &amp; = 1\\
\end{array}
\]</span></p>
<p>然後我們就可以從 <span class="math inline">\(\frac{\partial x}{\partial x} = 1, \frac{\partial y}{\partial x} = 0\)</span> 開始，求出 <span class="math inline">\(\frac{\partial w_i}{\partial x} \big \vert_{i = 1 \cdots 5}\)</span>，最後求出<span class="math inline">\(\frac{\partial Y}{\partial x}\)</span> （如上圖（右），這邊用 <span class="math inline">\(\dot{X}\)</span> 來表示 <span class="math inline">\(\frac{\partial X}{\partial x}\)</span>）。</p>
<p>從計算順序上，Forward-Mode AD 跟原先函數是一樣的，所以被稱為 Forward Mode。</p>
<section id="實作-1" class="level2">
<h2>實作</h2>
<p>一個常見的實作方法是定義一個新的資料結構 Dual Number，跟利用 operator overloading 來實作其算術系統。下面使用 Python 舉例<span><label for="sn-6" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-6" class="margin-toggle"/><span class="sidenote">較完整的 Dual Number 定義可以在 <a href="https://en.wikipedia.org/wiki/Automatic_differentiation#Automatic_differentiation_using_dual_numbers">Wikipedia</a> 找到。如同文中寫到，我們可以使用 <span class="math inline">\(g(\langle u,u&#39; \rangle , \langle v,v&#39; \rangle )  = \langle g(u,v) , g_u(u,v) u&#39; + g_v(u,v) v&#39; \rangle\)</span> 來定義這些 primitive functions(<span class="math inline">\(sin, cos, \cdots\)</span>)。<br />
<br />
</span></span><span><label for="sn-7" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-7" class="margin-toggle"/><span class="sidenote">為了可以寫出像是 <code class="sourceCode python"><span class="dv">4</span> <span class="op">*</span> Dual(<span class="dv">1</span>, <span class="dv">1</span>)</code> 這樣混合著 <code>float</code> 跟 <code>Dual</code> 的程式，可以參考 <a href="https://docs.python.org/3/reference/datamodel.html#emulating-numeric-types">Python Reference §3.3.7</a> 使用 <code>__radd__</code> 系列的 method 來實作。<br />
<br />
</span></span>：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="im">from</span> collections <span class="im">import</span> namedtuple</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="im">import</span> math</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">class</span> Dual(namedtuple(<span class="st">&quot;Dual&quot;</span>, [<span class="st">&quot;x&quot;</span>, <span class="st">&quot;dx&quot;</span>])):</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="co">&#39;&#39;&#39;dx 追蹤 x 的變化對當下輸出的影響&#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>, other):</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">        <span class="cf">return</span> Dual(<span class="va">self</span>.x <span class="op">+</span> other.x, <span class="va">self</span>.dx <span class="op">+</span> other.dx)</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="kw">def</span> <span class="fu">__mul__</span>(<span class="va">self</span>, other):</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">        <span class="cf">return</span> Dual(<span class="va">self</span>.x <span class="op">*</span> other.x, other.x <span class="op">*</span> <span class="va">self</span>.dx <span class="op">+</span> <span class="va">self</span>.x <span class="op">*</span> other.dx)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    <span class="co"># 下略</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">def</span> sin(dual):</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">    <span class="co"># inline chain rule here</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">    <span class="cf">return</span> Dual(math.sin(dual.x), dual.dx <span class="op">*</span> math.cos(dual.x))</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co"># 這邊省略其他函數</span></a></code></pre></div>
<p>舉例來說，我們可以透過控制<code>Dual(x, dx)</code>的<code>dx</code>來分別計算 <span class="math inline">\(\frac{\partial f}{\partial x}\)</span> 跟 <span class="math inline">\(\frac{\partial f}{\partial y}\)</span></p>
<p><span><label for="sn-8" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-8" class="margin-toggle"/><span class="marginnote"> <a href="https://upload.wikimedia.org/wikipedia/commons/a/a4/ForwardAccumulationAutomaticDifferentiation.png"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/ForwardAccumulationAutomaticDifferentiation.png/512px-ForwardAccumulationAutomaticDifferentiation.png" /></a> 這是 Wikipedia 上面對 <span class="math inline">\(Y = f(x,y) = sin(x) + x × y\)</span> 做 forward-mode AD 的示意圖。<br />
By Berland at English Wikipedia [Public domain], via Wikimedia Commons<br />
<br />
</span></span></p>
<p><span class="math display">\[f(x,y) = sin(x) + x*y\]</span></p>
<p>（<code class="sourceCode python">Dual(x, <span class="dv">1</span>)</code> 對應到 <span class="math inline">\(\frac{dx}{dx} = 1\)</span>；<code class="sourceCode python">Dual(c, <span class="dv">0</span>)</code> 對應到 <span class="math inline">\(\frac{dc}{dx} = 0\)</span>）</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># 要計算偏導數的函數可以用本來的寫法，而不用自幹，有沒有感覺到「自動」？</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">def</span> f(x, y):</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="cf">return</span> sin(x) <span class="op">+</span> x<span class="op">*</span>y</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">f(Dual(<span class="dv">3</span>, <span class="dv">1</span>), Dual(<span class="dv">2</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># Dual(x=6.141120008059867, dx=1.0100075033995546)</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">f(Dual(<span class="dv">3</span>, <span class="dv">0</span>), Dual(<span class="dv">2</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co"># Dual(x=6.141120008059867, dx=3.0)</span></a></code></pre></div>
<p>這是怎麼辦到的？我們可以用類似 Equational Reasoning<span><label for="sn-9" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-9" class="margin-toggle"/><span class="sidenote">Equational Reasoning 就像數學證明一樣，比較常用在 Pure Functional 的程式語言上，不過既然這個例子也幾乎是 Pure Functional 的，在這邊就使用這個技巧來說明。<br />
<br />
</span></span> 的方式來展開：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1">(  f(Dual(<span class="dv">3</span>, <span class="dv">1</span>), Dual(<span class="dv">2</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="op">==</span> sin(Dual(<span class="dv">3</span>, <span class="dv">1</span>)) <span class="op">+</span> Dual(<span class="dv">3</span>, <span class="dv">1</span>) <span class="op">*</span> Dual(<span class="dv">2</span>,<span class="dv">0</span>)                        <span class="co"># definition of f</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="op">==</span> Dual(math.sin(<span class="dv">3</span>), <span class="dv">1</span> <span class="op">*</span> math.cos(<span class="dv">3</span>)) <span class="op">+</span> Dual(<span class="dv">3</span>, <span class="dv">1</span>) <span class="op">*</span> Dual(<span class="dv">2</span>,<span class="dv">0</span>)     <span class="co"># definition of sin</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="op">==</span> Dual(math.sin(<span class="dv">3</span>), <span class="dv">1</span> <span class="op">*</span> math.cos(<span class="dv">3</span>)) <span class="op">+</span> Dual(<span class="dv">3</span> <span class="op">*</span> <span class="dv">2</span>, <span class="dv">2</span> <span class="op">*</span> <span class="dv">1</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">0</span>) <span class="co"># definition of __mul__</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="op">==</span> Dual(math.sin(<span class="dv">3</span>) <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">2</span>, <span class="dv">1</span> <span class="op">*</span> math.cos(<span class="dv">3</span>) <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> <span class="dv">1</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> <span class="dv">0</span>)      <span class="co"># definition of __add__</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="op">==</span> Dual(x<span class="op">=</span><span class="fl">6.141120008059867</span>, dx<span class="op">=</span><span class="fl">1.0100075033995546</span>)  )</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co"># returns True since this is a valid python expression.</span></a></code></pre></div>
<p>順帶一提，我們不需要額外實作 Chain Rule，因為它已經包含在 Dual Number 的算術系統內了。</p>
<p><span><label for="sn-10" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-10" class="margin-toggle"/><span class="marginnote"> 可以看到第 3 行的 <code>dx</code> 正好等於應用 Chain Rule 求出的 <span class="math inline">\(\frac{\partial sin(sin(x))}{\partial x} = cos(x) × cos(sin(x))\)</span>。<br />
這是因為在 <code>sin(dual)</code> 的定義中 <code class="sourceCode python">Dual(math.sin(dual.x), dual.dx <span class="op">*</span> math.cos(dual.x))</code> 裡面就已經 <em>inline</em> chain rule 了<br />
<br />
</span></span></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource python numberLines"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1">(  sin(sin(Dual(<span class="dv">1</span>, <span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="op">==</span> sin(Dual(math.sin(<span class="dv">1</span>), <span class="dv">1</span> <span class="op">*</span> math.cos(<span class="dv">1</span>)))                          <span class="co"># definition of sin</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="op">==</span> Dual(math.sin(math.sin(<span class="dv">1</span>)), math.cos(<span class="dv">1</span>) <span class="op">*</span> math.cos(math.sin(<span class="dv">1</span>))) <span class="co"># definition of sin</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="op">==</span> Dual(x<span class="op">=</span><span class="fl">0.7456241416655579</span>, dx<span class="op">=</span><span class="fl">0.36003948908962097</span>) )</a></code></pre></div>
<!--

左圖為$f = sin(x) + x * y$的示意圖，右邊為以 Dual Number 實作的示意圖：

~~~~
        f(x, y)    |       f(x, y); dfdx                      f(3,2); dfdx
          +-+      |          +---+---+                       +-----+-----+
          |+|      |          | + | + |                       |6.14 | 1.01|
          +-+      |          +---+---+                       +-----+-----+
         /  \      |          /       \                        /       \
        /    \     |         /         \                      /         \
    +---+     +-+  |  +------+------+  +--+----------+   +----+-----+   +--+--+
    |sin|     |×|  |  |sin(a)|cos(a)|  |× | a*db+b*db|   |0.14|-0.98|   | 6| 2|
    +---+     +-+  |  +------+------+  +--+----------+   +----+-----+   +--+--+
      |       /|   |        |           / |                   |          / |
      | _____/ |   |        |  ________/  |                   |  _______/  |
      |/       |   |        | /           |                   | /          |
     +-+      +-+  |     +--+--+       +--+--+             +--+--+      +--+--+
     |x|      |y|  |     |x | 1|       |y | 0|             |3 | 1|      |2 | 0|
     +-+      +-+  |     +--+--+       +--+--+             +--+--+      +--+--+
~~~~

-->
<p>這個方法的問題是每一個參數<span class="math inline">\(x_i\)</span>都必須算過一次，類神經的梯度來說需要<span class="math inline">\(O(n)\)</span>的時間才能算完（<span class="math inline">\(n\)</span>是參數的個數），並不是很適合類神經網路計算梯度（因為<span class="math inline">\(n\)</span>通常都不小）。</p>
</section>
</section>
<section id="小結" class="level1">
<h1>小結</h1>
<p>本文介紹了</p>
<ul>
<li>Numerical Differential，用近似的方法計算，其優點是實作最簡單，缺點是計算誤差大到不夠實用</li>
<li>Symbolic Differential，其實就是把人類計算微分的過程用電腦實作，可以得到正確的數值，但是會遇到算式膨脹的問題</li>
<li>Forward-Mode Automatic Differential，應用了 chain rule，在計算的過程也可以簡單的算出正確的偏導數，但是不適合計算梯度。</li>
</ul>
<p>下一篇文章會介紹 Reverse-Mode Automatic Differential，是 Forward-Mode 相反方向的版本，同時也是 back propagation 的 general 版本。</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Automatic_differentiation">Automatic differentiation on Wikipedia</a></li>
<li><a href="https://idontgetoutmuch.wordpress.com/2013/10/13/backpropogation-is-just-steepest-descent-with-automatic-differentiation-2">Backpropogation is Just Steepest Descent with Automatic Differentiation</a></li>
<li><a href="https://arxiv.org/pdf/1502.05767.pdf">Automatic Differentiation in Machine Learning: a Survey</a></li>
<li><a href="https://arxiv.org/pdf/1404.7456.pdf">Automatic Differentiation of Algorithms for Machine Learning</a></li>
</ul>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<section id="example-logistic-regression" class="level2">
<h2>Example: Logistic Regression</h2>
<p>這邊用挑戰者號的O型環失效資料<span><label for="sn-11" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-11" class="margin-toggle"/><span class="marginnote"> 選這份資料是因為我最近在讀 “Probabilistic Programming &amp; Bayesian Methods for Hackers” 剛好介紹到這一份<a href="https://raw.githubusercontent.com/CamDavidsonPilon/Probabilistic-Programming-and-Bayesian-Methods-for-Hackers/master/Chapter2_MorePyMC/data/challenger_data.csv">資料集</a>。<br />
<br />
</span></span>作為範例，以上述的 Forward-Mode AD<span><label for="sn-12" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-12" class="margin-toggle"/><span class="marginnote"> <strong>注意:</strong> 這邊的 <code>forwardad</code> 已經有實作 <code>__radd__</code>, <code>exp</code>, <code>log</code>…等滿足下面程式所需的最小需求。<br />
<br />
</span></span> 實作 Gradient Descent 來進行 Logistic Regression。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python example"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="im">from</span> forwardad <span class="im">import</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="im">from</span> io <span class="im">import</span> StringIO</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">data <span class="op">=</span> StringIO(<span class="st">&#39;Date,Temperature,Damage Incident</span><span class="ch">\n</span><span class="st">04/12/1981,66,0.0</span><span class="ch">\n</span><span class="st">11/12/1981,70,1.0</span><span class="ch">\n</span><span class="st">3/22/82,69,0.0</span><span class="ch">\n</span><span class="st">6/27/82,80,</span><span class="ch">\n</span><span class="st">01/11/1982,68,0.0</span><span class="ch">\n</span><span class="st">04/04/1983,67,0.0</span><span class="ch">\n</span><span class="st">6/18/83,72,0.0</span><span class="ch">\n</span><span class="st">8/30/83,73,0.0</span><span class="ch">\n</span><span class="st">11/28/83,70,0.0</span><span class="ch">\n</span><span class="st">02/03/1984,57,1.0</span><span class="ch">\n</span><span class="st">04/06/1984,63,1.0</span><span class="ch">\n</span><span class="st">8/30/84,70,1.0</span><span class="ch">\n</span><span class="st">10/05/1984,78,0.0</span><span class="ch">\n</span><span class="st">11/08/1984,67,0.0</span><span class="ch">\n</span><span class="st">1/24/85,53,1.0</span><span class="ch">\n</span><span class="st">04/12/1985,67,0.0</span><span class="ch">\n</span><span class="st">4/29/85,75,0.0</span><span class="ch">\n</span><span class="st">6/17/85,70,0.0</span><span class="ch">\n</span><span class="st">7/29/85,81,0.0</span><span class="ch">\n</span><span class="st">8/27/85,76,0.0</span><span class="ch">\n</span><span class="st">10/03/1985,79,0.0</span><span class="ch">\n</span><span class="st">10/30/85,75,1.0</span><span class="ch">\n</span><span class="st">11/26/85,76,0.0</span><span class="ch">\n</span><span class="st">01/12/1986,58,1.0</span><span class="ch">\n</span><span class="st">1/28/86,31,1.0</span><span class="ch">\n</span><span class="st">&#39;</span>)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">df <span class="op">=</span> pd.read_csv(data).dropna()</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">X <span class="op">=</span> df[<span class="st">&#39;Temperature&#39;</span>].tolist()</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">Y <span class="op">=</span> df[<span class="st">&#39;Damage Incident&#39;</span>].tolist()</a></code></pre></div>
<p>這邊使用 logistic function 做模型，binary cross-entropy 作為 loss function。</p>
<p><span class="math display">\[
\begin{gathered}
f(x) = \frac{1}{1+ exp(\beta x + \alpha)} \\
Cost(y, \hat y) = -\frac{1}{N}\sum_{i=1}^N \bigg[ y_i \log(\hat{y}_i)+(1-y_i) \log(1-\hat{y}_i) \bigg]
\end{gathered}
\]</span> <span><label for="sn-13" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-13" class="margin-toggle"/><span class="marginnote"> 這邊可以看到，寫出來的程式幾乎沒有為了計算微分而改變，而是照著本來的定義在寫。<br />
<br />
</span></span></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python example"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">def</span> f(alpha, beta, x):</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">    <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> exp(beta <span class="op">*</span> x <span class="op">+</span> alpha))</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw">def</span> cross_entroy(Y, Y_):</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">    loss <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">    <span class="cf">for</span> y, y_ <span class="kw">in</span> <span class="bu">zip</span>(Y, Y_):</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">        loss <span class="op">-=</span> y <span class="op">*</span> log(y_) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> y) <span class="op">*</span> log(<span class="dv">1</span> <span class="op">-</span> y_)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">    <span class="cf">return</span> loss <span class="op">/</span> <span class="bu">len</span>(Y)</a></code></pre></div>
<p>最後使用 Gradient Descent 來找出 <span class="math inline">\(\alpha, \beta\)</span>。</p>
<p><span><label for="sn-14" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-14" class="margin-toggle"/><span class="marginnote"> <code>alpha</code>, <code>beta</code>, <code>lr</code>, <code>n_epoch</code> 這些參數都是可以設定的。<br />
<br />
</span></span></p>
<p><span><label for="sn-15" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-15" class="margin-toggle"/><span class="marginnote"> 受限於 Forward-Mode AD 先天上的限制，<span class="math inline">\(\alpha\)</span> 跟 <span class="math inline">\(\beta\)</span> 的微分需要分開計算。<br />
<br />
</span></span></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python example"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" data-line-number="1">alpha <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">beta  <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">lr <span class="op">=</span> <span class="fl">0.005</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">n_epoch <span class="op">=</span> <span class="dv">1000</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># 為了避免 log(0) ，這邊先置換成 0 ≈ 1e-18</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">Y <span class="op">=</span> [<span class="fl">1e-18</span> <span class="cf">if</span> x <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> x <span class="cf">for</span> x <span class="kw">in</span> Y]</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(n_epoch):</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">    Y_alpha <span class="op">=</span> [f(Dual(alpha, <span class="dv">1</span>), beta, x) <span class="cf">for</span> x <span class="kw">in</span> X]</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">    Y_beta  <span class="op">=</span> [f(alpha, Dual(beta, <span class="dv">1</span>), x) <span class="cf">for</span> x <span class="kw">in</span> X]</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">    loss_alpha <span class="op">=</span> cross_entroy(Y, Y_alpha)</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">    loss_beta  <span class="op">=</span> cross_entroy(Y, Y_beta)</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">    <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">        <span class="bu">print</span>(<span class="ss">f&#39;</span><span class="sc">{</span>epoch<span class="sc">: 5d}</span><span class="ss"> loss </span><span class="sc">{</span>loss_alpha<span class="sc">.x}</span><span class="ss"> alpha </span><span class="sc">{</span>alpha<span class="sc">}</span><span class="ss"> beta </span><span class="sc">{</span>beta<span class="sc">}</span><span class="ss">&#39;</span>)</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">    alpha <span class="op">-=</span> lr <span class="op">*</span> loss_alpha.dx</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">    beta  <span class="op">-=</span> lr <span class="op">*</span> loss_beta.dx</a></code></pre></div>
<p>這邊是上面程式執行的結果（重新排版過），可以看到 Learning Rate 設定的有點太大了。有興趣的讀者可以試著自己實作看看。</p>
<pre><code>    0 loss 0.693147180559945  alpha  0                   beta  0
  100 loss 0.966931426916483  alpha -0.0201008838271800  beta  0.0465418617995232
  200 loss 1.114664696718874  alpha -0.0417346760460772  beta -0.0170795861942109
  300 loss 3.558155059566457  alpha -0.0595466871292758  beta  0.1800165252346373
  400 loss 0.961973323155755  alpha -0.0821799396148940  beta  0.0472951650365717
  500 loss 1.110644944663376  alpha -0.1037522632990092  beta -0.0161308641984885
  600 loss 3.555985812065263  alpha -0.1215047609258659  beta  0.1809462252622945
  700 loss 0.957097575658038  alpha -0.1440822016889158  beta  0.0480494092224557
  800 loss 1.106712443731962  alpha -0.1655931706446121  beta -0.0151865701942648
  900 loss 3.553772437842705  alpha -0.1832862200585766  beta  0.1818707335807102</code></pre>
</section>
</section>]]></description>
    <pubDate>Tue, 09 Jan 2018 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-12-17-autodiff.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>更換 blog 主題以迎接 2018 年</title>
    <link>https://op8867555.github.io/posts/2018-01-05-new-style.html</link>
    <description><![CDATA[<section>
<p>過了 2017，我決定換掉之前用 Google 的 <a href="https://getmdl.io/">Material Design Lite</a> 手刻的 css，改用了 <a href="https://github.com/edwardtufte/tufte-css">Tufte CSS</a> <span><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="sidenote">正確來說是它的 pandoc 版 fork “<a href="https://github.com/jez/tufte-pandoc-css">tufte-pandoc-css</a>”<br />
<br />
</span></span> 這套以 Edward Tufte 的書籍及手稿<span><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle"/><span class="sidenote">我沒看過，但是就是樣利用兩欄設計，把 foot note 改作 side note 的風格。<br />
<br />
</span></span>的風格為基礎的主題。</p>
<p>這邊特地截了兩者的截圖以作為紀念（不過其實<code>git checkout</code>一下也行）</p>
<p><span><label for="sn-3" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-3" class="margin-toggle"/><span class="marginnote"> 之前的主題走 Material Design 的卡片風格，以無襯線的黑體為主。 <a href="https://i.imgur.com/TQjq0Ju.png"><img src="https://i.imgur.com/TQjq0Ju.png" /></a><br />
<br />
</span></span></p>
<p><a href="https://i.imgur.com/e5mGJpO.png"><img src="https://i.imgur.com/e5mGJpO.png" /></a></p>
<p>除此之外，我還做了：</p>
<ul>
<li>改用 <a href="https://khan.github.io/KaTeX/"><span class="math inline">\(\KaTeX\)</span></a> 這個前端渲染引擎來呈現 LaTeX 的運算式，相較於之前 pandoc 的基本款實作支援更多語法，而且渲染結果也好看了不少。</li>
<li>使用 pandoc 的 <code>eastAsianLineBreakFilter</code> 來改進中文斷行的呈現。</li>
</ul>
</section>]]></description>
    <pubDate>Fri, 05 Jan 2018 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2018-01-05-new-style.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>筆記：幾個 CLI 實用工具: ag, fzf, fd, ripgrep</title>
    <link>https://op8867555.github.io/posts/2017-11-27-cli-tools-ag-rg-fzf-fd.html</link>
    <description><![CDATA[<p>筆記最近用的幾個 CLI 工具。</p>
<section id="the-silver-searcher" class="level1">
<h1>The Silver Searcher</h1>
<p><a href="https://github.com/ggreer/the_silver_searcher">The Silver Searcher</a> 是一個類似 ack 的搜尋工具，也就是找出出現某字串的所有檔案。</p>
<ul>
<li>飛天快</li>
<li>預設排除 <code>.gitignore</code> <code>.hgignore</code> 裡的 pattern</li>
<li>其他不想要的 pattern 可以寫在 <code>.ignore</code></li>
<li>用 c 實作</li>
<li>直到 <span class="citation" data-cites="caasih">@caasih</span> 提到之前我都沒發現執行檔名稱 <code>ag</code> 是水銀的元素符號</li>
</ul>
</section>
<section id="ripgrep" class="level1">
<h1>ripgrep</h1>
<p><a href="https://github.com/BurntSushi/ripgrep">Ripgrep</a> 跟前述的 The Silver Searcher 功能差不多</p>
<ul>
<li>但是比飛天快還快</li>
<li>對於 ignore 檔案的實作更正確，ag 會多吐一些不應該出現的結果</li>
<li>regexp 的功能比較少（比方說我從來沒用過的 lookaround 跟 backreference 就沒有實作）</li>
<li>用 rust 實作</li>
</ul>
</section>
<section id="fd" class="level1">
<h1>fd</h1>
<p><a href="https://github.com/sharkdp/fd">fd</a> 是一個類似 find 的檔案搜尋工具</p>
<ul>
<li>也會預設排除 <code>.gitignore</code></li>
<li>預設排除隱藏檔案</li>
<li>也是飛天快</li>
<li>也是 rust 實作</li>
</ul>
<section id="範例" class="level2">
<h2>範例</h2>
<ul>
<li><p>用 regexp 搜尋</p>
<pre><code>fd &#39;[0-9]\.jpg$&#39;</code></pre></li>
<li><p>搜尋隱藏檔案跟被 ignore 的檔案</p>
<pre><code>fd -H -I &#39;[0-9]\.jpg$&#39;</code></pre></li>
<li><p>搜尋特定副檔名</p>
<pre><code>fd -e jpg</code></pre></li>
<li><p>對搜尋結果下指令<strong>平行執行</strong></p>
<pre><code>fd -e jpg -x convert {} {.}.png</code></pre>
<table>
<thead>
<tr class="header">
<th>variable</th>
<th style="text-align: left;">example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>{}</td>
<td style="text-align: left;">documents/images/party.jpg</td>
</tr>
<tr class="even">
<td>{.}</td>
<td style="text-align: left;">documents/images/party</td>
</tr>
<tr class="odd">
<td>{/}</td>
<td style="text-align: left;">party.jpg</td>
</tr>
<tr class="even">
<td>{//}</td>
<td style="text-align: left;">documents/images</td>
</tr>
<tr class="odd">
<td>{/.}</td>
<td style="text-align: left;">party</td>
</tr>
</tbody>
</table></li>
</ul>
</section>
</section>
<section id="fzf" class="level1">
<h1>fzf</h1>
<p><a href="https://github.com/junegunn/fzf">fzf</a> 是一個 fuzzy finder，就是 cmd+T 或是 ctrl+p 或是任何一個 文字編輯器/IDE 裡面不用打全名就可以找檔案的那個功能</p>
<ul>
<li>用 go 寫的</li>
<li><p>預設用 find ，所以很慢，用環境變數可以換用 fd</p>
<p>export FZF_DEFAULT_COMMAND=‘fd –type f –follow –exclude .git’</p></li>
<li><p>ctrl+r 來搜尋歷史</p>
<blockquote class="imgur-embed-pub" lang="en" data-id="IwjCK2l">
<a href="//imgur.com/IwjCK2l">View post on imgur.com</a>
</blockquote>
<script async src="//s.imgur.com/min/embed.js" charset="utf-8"></script></li>
<li><p><code>**&lt;tab&gt;</code> 可以選取多個檔案</p>
<blockquote class="imgur-embed-pub" lang="en" data-id="ocxqb0C">
<a href="//imgur.com/ocxqb0C">View post on imgur.com</a>
</blockquote>
<script async src="//s.imgur.com/min/embed.js" charset="utf-8"></script></li>
<li><p>ctrl+t 來搜尋檔案</p>
<blockquote class="imgur-embed-pub" lang="en" data-id="SfiGWjD">
<a href="//imgur.com/SfiGWjD">View post on imgur.com</a>
</blockquote>
<script async src="//s.imgur.com/min/embed.js" charset="utf-8"></script></li>
</ul>
</section>]]></description>
    <pubDate>Mon, 27 Nov 2017 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-11-27-cli-tools-ag-rg-fzf-fd.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>[EN] Use your UNIX toolbox with pandas</title>
    <link>https://op8867555.github.io/posts/2017-10-13-use-your-unix-toolbox-with-pandas.html</link>
    <description><![CDATA[<p>I do analysis on log / csv / json files with a Python + Pandas + Jupyter Notebook stack at work. These files are so large that I usually need to do some pre-processing before loading them into memory.</p>
<p>UNIX tools are powerful to stream processing files: concatenation, filtering, transforming…, but it is annoying to “context-switch” between Jupyter Notebook and shell. Also, It’s generate immediate files that need to remove later manually, quite annoying.</p>
<p>After some stackoverflow-ing, I found a solution<span><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="sidenote"><a href="https://stackoverflow.com/questions/13651117/pandas-filter-lines-on-load-in-read-csv/13653490#13653490">pandas: filter lines on load in read_csv</a><br />
<br />
</span></span> says you can read files in chunks:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1">df <span class="op">=</span> pd.concat(process(chunk_df) <span class="co"># do processing in python</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">               <span class="cf">for</span> chunk_df <span class="kw">in</span> pd.read_csv(<span class="st">&#39;bigdata.csv&#39;</span>, chunksize<span class="op">=</span><span class="dv">10000</span>))</a></code></pre></div>
<p>But there is a big overhead to create/process immediate data-frames.</p>
<p>Another solution<span><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle"/><span class="sidenote"><a href="https://stackoverflow.com/questions/39864304/how-to-use-subprocess-and-cat-to-read-in-data-line-by-line/39864368#39864368">How to use subprocess and ‘cat’ to read in data line by line?</a><br />
<br />
</span></span> says you can use <code>subprocess</code> with PIPE, a clever idea. So I end up with this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="im">from</span> subprocess <span class="im">import</span> Popen, PIPE</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="cf">with</span> Popen(<span class="st">&#39;cat bigdata.csv | grep WHAT_I_CARE_ABOUT | some_transformations&#39;</span>,</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">           shell<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">           stdout<span class="op">=</span>PIPE) <span class="im">as</span> process:</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    df <span class="op">=</span> pd.read_csv(process.stdout)</a></code></pre></div>
<p>With this trick, I can now do some bash-fu with pandas in Jupyter-Notebook easily.</p>
<p><strong>Reading multiples files</strong></p>
<pre class="shell"><code>cat stats/2017/*/*.csv</code></pre>
<p><strong>JSON query with jq</strong></p>
<pre class="shell"><code>cat data.json | jq &#39;{.loc = .loc}&#39;</code></pre>
<p><strong>filter lines with awk or grep</strong></p>
<pre class="shell"><code>zcat data.csv.gz | grep &#39;SOME_TAG&#39; | awk &#39;$1 == 2017&#39;</code></pre>
<p><strong>pipe over files in .tar</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="fu">tar</span> -xOf bigdatas.tar.gz --wildcards <span class="st">&quot;*.data.csv&quot;</span></a></code></pre></div>]]></description>
    <pubDate>Fri, 13 Oct 2017 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-10-13-use-your-unix-toolbox-with-pandas.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>應用 git bisect 找出 linux kernel 中出現問題的 commit</title>
    <link>https://op8867555.github.io/posts/2017-10-05-bisecting-linux-kernel-bug.html</link>
    <description><![CDATA[<section id="tldr" class="level3">
<h3>TL;DR</h3>
<p>這篇文章筆記我使用 git bisect 來找出 linux kernel (drm/i915) 中的導致行為異常的是哪一個 commit 的過程。</p>
</section>
<section id="起因" class="level1">
<h1>起因</h1>
<p>我的筆電上裝的是 Arch Linux，Chromium 在 linux 上是<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=463440">不會有硬體加速功能</a>的，為了減少 CPU 資源的浪費，也為了增加續航力，我使用的是一個非官方版本的 <a href="https://aur.archlinux.org/packages/chromium-vaapi/">chromium-vaapi</a>。</p>
<p>最近做完系統更新之後發現硬體加速的功能出了些異常，在跟 AUR package 的使用者討論後得知：</p>
<ul>
<li>mesa 的版本會影響，但是降版之後有不同的異常</li>
<li>這個不同的異常只有在播放 VP9 格式的影片時會發生</li>
<li>在一番亂試之後發現到 kernel 降回 4.12 就沒事了！</li>
</ul>
<p>做了一些功課之後，我認為這個 bug 是來自於 linux kernel 中 DRM/i915 的部份，於是我便開始嘗試從茫茫 commit 海撈出那個針。</p>
</section>
<section id="找出問題之旅" class="level1">
<h1>找出問題之旅</h1>
<section id="drm-tip" class="level2">
<h2>drm-tip</h2>
<p>drm-tip 是裡面包含著不同的幾個團隊所維護的 drm 實作的 linux kernel</p>
<figure>
<img src="https://01.org/linuxgraphics/gfx-docs/maintainer-tools/_images/drm-intel-flow.svg" alt="這個 merge flow 很複雜，我也還沒搞懂" /><figcaption>這個 merge flow 很複雜，我也還沒搞懂</figcaption>
</figure>
</section>
<section id="在-archlinux-上編譯" class="level2">
<h2>在 ArchLinux 上編譯</h2>
<p>幸好我不必了解他們是怎麼 merge，只需要 build 起來能測試功能是否正常即可。</p>
<ul>
<li>使用 AUR 上面的 <a href="https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=linux-drm-tip-git&amp;id=f2f3487589a22ee728472259f4bd79af75bd782b">linux-drm-tip-git</a> 這個 package 編譯最新的版本</li>
<li>遇到 <code>make prepare</code> 詢問參數是因為 <code>config.x86-64</code> 的版本不夠新
<ul>
<li>我直接找了 <a href="https://aur.archlinux.org/packages/linux-mainline/">linux-mainline</a> 的來用</li>
</ul></li>
<li>先用 <code>makepkg -Asi</code> 編譯安裝一遍。</li>
<li>然後使用這個版本的 kernel 後發現、恩、問題依舊</li>
</ul>
</section>
<section id="加快編譯速度" class="level2">
<h2>加快編譯速度</h2>
<p>我用了兩個工具來加速編譯速度：</p>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/ccache">ccache</a>: 幫 gcc 做快取，改善重複編譯所需的時間</li>
<li><a href="https://wiki.archlinux.org/index.php/Modprobed-db">modprobed-db</a>: 減少所需編譯的模組數</li>
</ul>
</section>
<section id="bisect" class="level2">
<h2>bisect</h2>
<p>要從至少 27000 筆的 commit 中找錯誤，當然不會一筆一筆嘗試。這邊使用的 bisect 就是用經典的演算法「二分搜尋法」來加快尋找的速度。</p>
<section id="步驟" class="level3">
<h3>步驟</h3>
<ul>
<li>編譯完之後，進 <code>src/drm-tip</code> 執行 <code>git bisect start</code></li>
<li>確認問題還在，標記為有問題的版本 <code>git bisect bad</code></li>
<li><code>git checkout</code> 到認為沒問題的版本（因為我知道 4.12 沒有問題，所以我找到對應的 commit 是<code>6f7da29</code>）</li>
<li><code>makepkg -esfi</code> 編譯並安裝此版本
<ul>
<li>因為 <code>git bisect</code> 會 checkout 到不同的版本，所以需要用 <code>-e</code> 來告訴 makepkg 不要重新 checkout</li>
</ul></li>
<li><p>重開機檢查問題是否還在，沒有問題，用 <code>git bisect good</code> 標記</p>
<pre class="shell"><code>&gt; git bisect good
Bisecting: 13952 revisions left to test after this (roughly 14 steps)
[73adb8c5b0ea15e3942ab5781eb3e72d4e028ada] Merge tag &#39;for-4.13/dm-fixes-2&#39; of git://git.kernel.org/pub/scm/linux/kernel/git/device-mapper/linux-dm</code></pre></li>
</ul>
</section>
<section id="預估還要幾次查詢" class="level3">
<h3>預估還要幾次查詢</h3>
<ul>
<li><code>git rev-list drm-tip ^6f7da290413b --count</code> 告訴我這兩個中間差了 27906 個 commit</li>
<li>所以我預期最多還需要 16 次的篩選 (<span class="math inline">\(log_2(27906)+1 \approx 15.77\)</span>)</li>
</ul>
</section>
<section id="繼續尋找問題" class="level3">
<h3>繼續尋找問題</h3>
<p>這邊就是不斷的重複：</p>
<ul>
<li>編譯</li>
<li>測試</li>
<li><code>git bisect [good|bad]</code></li>
</ul>
<pre class="half-page"><code>&gt; git bisect bad 73adb8c5b0ea
Bisecting: 6975 revisions left to test after this (roughly 13 steps)
[4f5dfdd29065a0d1d0e61d9744e14d1d852518be] Merge tag &#39;leds_for_4.13&#39; of git://git.kernel.org/pub/scm/linux/kernel/git/j.anaszewski/linux-leds

&gt; git bisect good 4f5dfdd29065
Bisecting: 3487 revisions left to test after this (roughly 12 steps)
[8c03cc85a035ae7a208c28c4382ecfeb6adf79a6] fs/proc/task_mmu.c: remove obsolete comment in show_map_vma()

&gt; git bisect bad 8c03cc85a035
Bisecting: 1723 revisions left to test after this (roughly 11 steps)
[2ceedf97aef41d071d897a6e6aec8c05fb707ec4] Merge tag &#39;dmaengine-4.13-rc1&#39; of git://git.infradead.org/users/vkoul/slave-dma

&gt; git bisect good 2ceedf97aef4
Bisecting: 818 revisions left to test after this (roughly 10 steps)
[04d4fb5fa63876d8e7cf67f2788aecfafc6a28a7] Merge branch &#39;drm-next-4.13&#39; of git://people.freedesktop.org/~agd5f/linux into drm-next

&gt; git bisect good 04d4fb5fa638
Bisecting: 420 revisions left to test after this (roughly 9 steps)
[00fc2c26bc46a64545cdf95a1511461ea9acecb4] drm: Remove unused drm_file parameter to drm_syncobj_replace_fence()

&gt; git bisect bad 00fc2c26bc46
Bisecting: 222 revisions left to test after this (roughly 8 steps)
[eafae133e48c9e5f5537d5c6df34eab912336b9a] Merge tag &#39;drm-msm-next-2017-06-20&#39; of git://people.freedesktop.org/~robclark/linux into drm-next

&gt; git bisect good eafae133e48c
Bisecting: 111 revisions left to test after this (roughly 7 steps)
[fc59921178fd63f1dbe445c2fc86e6ca997a4744] drm/i915/perf: Add more OA configs for BDW, CHV, SKL + BXT

&gt; git bisect good fc59921178fd
Bisecting: 55 revisions left to test after this (roughly 6 steps)
[7dd4f6729f9243bd7046c6f04c107a456bda38eb] drm/i915: Async GPU relocation processing

&gt; git bisect bad 7dd4f6729f92
Bisecting: 34 revisions left to test after this (roughly 5 steps)
[615c16a9d8649b9894592d11bc393e684b11e2ea] drm/i915/gvt: Refine virtual reset function

&gt; git bisect good 615c16a9d864
Bisecting: 17 revisions left to test after this (roughly 4 steps)
[f6262bda462e81e959b80a96dac799bd9df27f73] drm/i915: Don&#39;t enable backlight at setup time.

&gt; git bisect good f6262bda462e
Bisecting: 8 revisions left to test after this (roughly 3 steps)
[4c9c0d09741deab0aac76b83961cfe95b24f3e6f] drm/i915: Fix retrieval of hangcheck stats

&gt; git bisect good 4c9c0d09741d
Bisecting: 4 revisions left to test after this (roughly 2 steps)
[2889caa9232109afc8881f29a2205abeb5709d0c] drm/i915: Eliminate lots of iterations over the execobjects array

&gt; git bisect bad 2889caa92321
Bisecting: 1 revision left to test after this (roughly 1 step)
[507d977ff965682a925ffe479c95136680fcb77b] drm/i915: Pass vma to relocate entry

&gt; git bisect good 507d977ff965
Bisecting: 0 revisions left to test after this (roughly 0 steps)
[071750e550af46b5d3a84ad56c2a108c3e136284] drm/i915: Disable EXEC_OBJECT_ASYNC when doing relocations</code></pre>
</section>
<section id="找出有問題的-commit" class="level3">
<h3>找出有問題的 commit</h3>
<p>不斷重複上面的步驟，最後找出第一個有問題的 commit</p>
<pre><code>&gt; git bisect good 071750e550af
2889caa9232109afc8881f29a2205abeb5709d0c is the first bad commit</code></pre>
</section>
</section>
</section>
<section id="後記" class="level1">
<h1>後記</h1>
<p>這個過程並不是很輕鬆（編譯一次至少需要 10min，還要重開機測試），將這個找到的這個 commit 回報上去之後，開發者很快的就能找到問題的關鍵點。</p>
<p>最後得到的結論是，這個問題應該是來自 user space driver 沒有實作正確，於是我回去找了 intel-vaapi-driver 的 issue tracker，才發現到原來早在 3 個星期前就有人<a href="https://github.com/01org/intel-vaapi-driver/issues/262">回報</a>過，而且也已經修正並 merge 回 master 了。囧</p>
<p>雖然最後發現不是 linux kernel 的問題，不過這也依然是個務實的除錯經驗。</p>
</section>
<section id="參考資料" class="level1">
<h1>參考資料</h1>
<p><strong>drm/i915</strong></p>
<ul>
<li><a href="https://01.org/linuxgraphics/documentation/how-report-bugs">how to report bugs</a></li>
<li><a href="https://01.org/linuxgraphics/gfx-docs/maintainer-tools/drm-intel.html">drm-intel</a></li>
</ul>
<p><strong>git bisect</strong></p>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/Bisecting_bugs">Bisecting bugs</a></li>
<li><a href="https://project-insanity.org/blog/2013/02/13/how-i-found-a-kernel-regression-using-git-bisect/">How I fixed a kernel regression using git bisect</a></li>
</ul>
</section>]]></description>
    <pubDate>Thu, 05 Oct 2017 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-10-05-bisecting-linux-kernel-bug.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>用 Python 計算經緯度對應的鄉鎮市區</title>
    <link>https://op8867555.github.io/posts/2017-09-16-python-getting-town-from-gps-coord.html</link>
    <description><![CDATA[<section id="tldr" class="level3">
<h3>TL;DR</h3>
<p>這篇文章筆記最近朋友問的一個問題： 如何不靠外部 API 取得一個經緯度座標落在哪一個鄉鎮市區。</p>
<p>這邊應用政府 open data 的 <a href="https://data.gov.tw/dataset/7441">鄉鎮市區界線</a> 資料，加上 python 的 shapely 做範圍判斷、用 rtree 建立索引加速查詢。</p>
</section>
<section id="實作筆記" class="level1">
<h1>實作筆記</h1>
<p>想法很單純，就是透過判斷座標(輸入的經緯度)有沒有落在多邊形(鄉鎮邊界)的範圍內。</p>
<section id="資料來源" class="level2">
<h2>資料來源</h2>
<p>政府有提供<a href="https://data.gov.tw/dataset/7441">鄉鎮市區界線</a>資料，是一個 <a href="https://en.wikipedia.org/wiki/Shapefile">Shapefile</a>。 Python 要讀取 .shp 檔不難，有很多 library 可以做到，可以參考<a href="https://gis.stackexchange.com/questions/113799/how-to-read-a-shapefile-in-python">這篇</a>。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="im">import</span> fiona</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="im">from</span> shapely.geometry <span class="im">import</span> shape, Point</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">collection <span class="op">=</span> fiona.<span class="bu">open</span>(<span class="st">&#39;./TOWN_MOI_1060525.shp&#39;</span>)</a></code></pre></div>
</section>
<section id="查詢" class="level2">
<h2>查詢</h2>
<p>這邊我使用的是 <code>shapely</code> 這個套件來計算座標有無座落於某個多邊形。 所以先將 .shp 內的 geometry 建立成 shapely 的 Polygon 物件：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1">shapes <span class="op">=</span> {}</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">properties <span class="op">=</span> {}</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="cf">for</span> f <span class="kw">in</span> collection:</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    town_id <span class="op">=</span> <span class="bu">int</span>(f[<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;TOWNCODE&#39;</span>])</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    shapes[town_id] <span class="op">=</span> shape(f[<span class="st">&#39;geometry&#39;</span>])</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    properties[town_id] <span class="op">=</span> f[<span class="st">&#39;properties&#39;</span>]</a></code></pre></div>
<p>這樣就可以用 <code class="sourceCode python">polygon.contains(Point(x, y))</code> 判斷一個點有沒有座落於其中。對這所有的多邊形走訪一遍就可以知道座落於哪裡：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">def</span> search(x, y):</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    <span class="cf">return</span> <span class="bu">next</span>((town_id</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">                 <span class="cf">for</span> town_id <span class="kw">in</span> shapes</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">                 <span class="cf">if</span> shapes[town_id].contains(Point(x, y))), <span class="va">None</span>)</a></code></pre></div>
</section>
<section id="加速查詢" class="level2">
<h2>加速查詢</h2>
<p>上面的查詢很單純地測試全台灣 368 個鄉鎮市的多邊形了一遍，如果是小量的輸入資料應該還算是可以接受，不過如果需要更細的比對（計算到村里）、或是有大量資料要計算的話，這樣的方法還是不夠有效率。</p>
<p>因為在查詢一個台北的座標時，其實不用考慮離他太遠的台中、台南…等其他鄉鎮市區。</p>
<p>基於這樣的想法，這邊用 R-Tree 這個<a href="https://en.wikipedia.org/wiki/R-tree">資料結構</a>來幫這些多邊形的 bounding box（多邊形的最小外接矩形）做索引：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="im">from</span> rtree <span class="im">import</span> index</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">idx <span class="op">=</span> index.Index()</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="cf">for</span> town_id, shape <span class="kw">in</span> shapes.items():</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    idx.insert(town_id, shape.bounds)</a></code></pre></div>
<p>這樣就可以透過 <code class="sourceCode python">idx.intersection((x, y))</code> 來找出跟座標有交集的 bounding box。我們只需要檢查座標落在其中的哪一個的多邊形即可：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">def</span> search(x, y):</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">    <span class="cf">return</span> <span class="bu">next</span>((town_id</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">                 <span class="cf">for</span> town_id <span class="kw">in</span> idx.intersection((x, y))</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">                 <span class="cf">if</span> shapes[town_id].contains(Point(x, y))), <span class="va">None</span>)</a></code></pre></div>
<p>這樣查詢的時間就可以從 <span class="math inline">\(O(N)\)</span> 加快到 <span class="math inline">\(O(log_M N + M)\)</span> 了。以鄉鎮市區來說，在我的筆電上，從本來每次平均需要 3.95ms 提升到每次平均 223 µs，至少快了 16 倍。</p>
<figure>
<img src="https://i.imgur.com/MDrOi7i.png" alt="以🇹🇼總統府來舉例，它落在萬華區跟中正區兩個 bounding boxes 裡面" /><figcaption>以🇹🇼總統府來舉例，它落在萬華區跟中正區兩個 bounding boxes 裡面</figcaption>
</figure>
</section>
</section>]]></description>
    <pubDate>Sat, 16 Sep 2017 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-09-16-python-getting-town-from-gps-coord.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>手動編譯 vs 編譯好的 tensorflow</title>
    <link>https://op8867555.github.io/posts/2017-09-09-tensorflow-prebuilt-vs-built-from-source.html</link>
    <description><![CDATA[<p>亂看文章時發現到 tensorflow prebuilt 版跟自己 build 效能有落差（現在想想這也是理所當然的事），於是就來自己編編看到底差多少了。</p>
<section id="實驗" class="level1">
<h1>實驗</h1>
<section id="使用的機器" class="level2">
<h2>使用的機器</h2>
<p>Thinkpad X1 Carbon 2017，它的 CPU 是 Intel 的 i7-7500U（對，這顆絕對不適合拿來算這個）</p>
</section>
<section id="使用的不同版本" class="level2">
<h2>使用的不同版本</h2>
<ul>
<li><p><a href="https://pypi.python.org/pypi/tensorflow">PyPI 上的版本</a>，沒有機器相關的最佳化。</p></li>
<li><p><a href="https://software.intel.com/en-us/articles/tensorflow-optimizations-on-modern-intel-architecture">intel 提供的版本</a> 使用 intel 的 Math Kernel library，但是沒有機器相關的最佳化<span><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="sidenote">沒有做機器相關的最佳化時會有提醒<br />
<br />
</span></span>。</p></li>
<li><p>自己 build ，用的是 tensorflow 官方 github repo 的 <a href="https://github.com/tensorflow/tensorflow/tree/32ffc5a81eee8c39bbe71536212a773b1ffd4eb2">32ffc5a81</a></p>
<ul>
<li><code>./configure</code> 都用預設值 (<code>-march=native</code> 開啟當下機器架構的最佳化）</li>
<li><code>--config=mkl</code> 同 intel 版本</li>
</ul></li>
</ul>
</section>
<section id="使用的測試案例" class="level2">
<h2>使用的測試案例</h2>
<p>使用了 keras 的幾個 <a href="https://github.com/fchollet/keras/tree/master/examples">example</a> 來測試<span><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle"/><span class="sidenote">問我為什麼要用 keras 而不用 tensorflow 就好？因為我還想測 theano 啊…<br />
<br />
</span></span>，分別是：</p>
<ul>
<li>mnist-mlp</li>
<li>mnist-cnn</li>
<li>cifar10-cnn</li>
</ul>
</section>
<section id="測試結果" class="level2">
<h2>測試結果</h2>
<table>
<caption>實驗結果（數值是每次 epoch 所花的時間，越小越好）</caption>
<thead>
<tr class="header">
<th style="text-align: left;">testcase</th>
<th style="text-align: right;">pip</th>
<th style="text-align: right;">intel</th>
<th style="text-align: right;">built</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mnist-mlp</td>
<td style="text-align: right;">9.5s</td>
<td style="text-align: right;">10.5s</td>
<td style="text-align: right;">10.5s</td>
</tr>
<tr class="even">
<td style="text-align: left;">mnist-cnn</td>
<td style="text-align: right;">175.5s</td>
<td style="text-align: right;">63s</td>
<td style="text-align: right;">60s</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cifar10-cnn[^1]</td>
<td style="text-align: right;">275s</td>
<td style="text-align: right;">200s</td>
<td style="text-align: right;">200s</td>
</tr>
</tbody>
</table>
<p><span><label for="sn-3" class="margin-toggle">&#8853;</label><input type="checkbox" id="sn-3" class="margin-toggle"/><span class="marginnote"> [^1] 因為有 200 個 epoch 要跑，實在要花很多時間，所以這邊就都只取大概 3~4 個 epoch 的時間來算<br />
<br />
</span></span></p>
</section>
<section id="結論" class="level2">
<h2>結論</h2>
<ul>
<li>如果是真心想要用 Intel 的 CPU 跑 tensorflow …
<ul>
<li>…也願意自己花時間編譯，那<strong>手動編譯</strong>是（執行時）最快的選項</li>
<li>…卻不想自己編，但可以接受不是最新的版本，那直接使用<a href="https://software.intel.com/en-us/articles/tensorflow-optimizations-on-modern-intel-architecture"><strong>intel 提供的版本</strong></a></li>
</ul></li>
<li>如果沒那麼真心想用，只是先用 CPU 玩玩看，那<a href="https://pypi.python.org/pypi/tensorflow"><strong>直接用 pip 裝</strong></a>是最簡易的選項。</li>
<li><em>真心想跑 tensorflow 還是去弄個有 GPU 的環境吧…</em>
<ul>
<li>用了 GTX 1060 6GB 的桌電跑 cifar10-cnn ，一個 epoch 只要 25s</li>
</ul></li>
</ul>
</section>
</section>]]></description>
    <pubDate>Sat, 09 Sep 2017 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-09-09-tensorflow-prebuilt-vs-built-from-source.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>筆記： DS216j 安裝 shadowsocks server</title>
    <link>https://op8867555.github.io/posts/2017-08-27-ds216j-shadowsocks.html</link>
    <description><![CDATA[<p>最近親戚弄了台 Synology DS216j 想拿來架 shadowsocks 的 server，這篇文章筆記我架這個 server 所走的路。</p>
<section id="changelogs" class="level3">
<h3>changelogs</h3>
<ul>
<li>2017-10-12 紀錄一下，現在上游有編好的 package 能用了</li>
</ul>
</section>
<section id="折騰過程" class="level1">
<h1>折騰過程</h1>
<p>提到在 NAS 上架 shadowsocks，可以查到很多用 docker 的解決方法，不過網路上的幾篇文章都說這台機器不能用 docker，所以我直接往 binary 的方法前進。</p>
<p>一開始看到的是這篇 <a href="http://jexbat.com/2016/NAS-Shadowsocks/">Synology DS216Play 安装 ShadowSocks</a>，從這篇文章中得出：</p>
<ul>
<li>原來有 package manager 可以用</li>
<li>shadowsocks 有用 python 跟 libev 的實作可以選</li>
</ul>
<section id="安裝package-manager" class="level2">
<h2>安裝package manager</h2>
<p>朝著安裝 package manager 的方向前進後找到了這篇<a href="https://ky0n.xyz/synology-ds216j-optware-ipkg-init/">Synology DS216j Optware IPKG 介紹</a>。<br />
看了看發現這是篇翻譯文，而原文有了更新的<a href="http://jasmin.sakura.ne.jp/blog/0245">版本🇯🇵</a>，發現到有 <a href="https://github.com/Entware-ng/Entware-ng/">entware-ng</a> 這個比 ipkg 更新的 package manager 能用，而且已經有 shadowsocks 的<a href="http://pkg.entware.net/binaries/armv7/Packages.html">套件能用</a>。</p>
</section>
<section id="安裝-entware-ng" class="level2">
<h2>安裝 entware-ng</h2>
<p>安裝的過程不難，大致上就是開好SSH、照著<a href="https://github.com/Entware-ng/Entware-ng/wiki/Install-on-Synology-NAS">其 wiki 上寫的步驟</a>就行。</p>
<p>筆記一下步驟：</p>
<ul>
<li><p>建立一個套件管理用的目錄，因為韌體更新會清 /opt ，所以要在外面建並 symlink 回去：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">mkdir</span> -p /volume1/@entware-ng/opt</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">rm</span> -rf /opt</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="fu">ln</span> -sf /volume1/@entware-ng/opt /opt</a></code></pre></div></li>
<li><p>安裝 entware</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu">wget</span> -O - http://pkg.entware.net/binaries/armv7/installer/entware_install.sh <span class="kw">|</span> <span class="ex">/bin/sh</span></a></code></pre></div></li>
<li><p>設定啟動腳本（重開機時把 entware 裝的服務也帶起來）<br />
編輯 /usr/local/etc/rc.d/entware-startup.sh （教學上沒有，但是我有順便做 <code>chmod +x</code>）</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">#!/bin/sh</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">case</span> <span class="va">$1</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    start<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="fu">mkdir</span> -p /opt</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="fu">mount</span> -o bind /volume1/@entware-ng/opt /opt</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    <span class="ex">/opt/etc/init.d/rc.unslung</span> start</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="kw">;;</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    stop<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    <span class="kw">;;</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">esac</span></a></code></pre></div></li>
<li><p>在登入時自動把 <code>/opt/bin</code> <code>/opt/sbin</code>加到 <code>PATH</code> 裡面：在 /etc/profile 內加上一行</p>
<pre><code>. /opt/etc/profile</code></pre></li>
</ul>
<p>裝完之後就是開心地來裝 shadowsocks</p>
<pre><code>opkg update
opkg install shadowsocks-libev</code></pre>
<p><del>但是裝完卻發現沒有 <code>ss-server</code> 這個執行檔！原因似乎是因為 entware-ng 沒有跟上流的 openwrt 同步 <span><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="sidenote"><a href="https://github.com/Entware-ng/entware-packages/commit/e3793bbbde8b907842f84731bfec292ccb069114" class="uri">https://github.com/Entware-ng/entware-packages/commit/e3793bbbde8b907842f84731bfec292ccb069114</a><br />
<br />
</span></span>，而不知為何的明明就有新的 Makefile ，除了 mipsel 以外卻沒有新的 binary package 能用。</del></p>
<section id="更新" class="level3">
<h3>2017/10/12 更新</h3>
<p>前一陣子 entware 有跟上游同步過，所以直接安裝 <code>shadowsocks-libev-ss-server</code> 跟 <code>shadowsocks-libev-config</code> 就行了</p>
<pre><code>opkg install shadowsocks-libev-config
opkg install shadowsocks-libev-ss-server</code></pre>
</section>
</section>
<section id="手動編譯" class="level2">
<h2>手動編譯</h2>
<p>沒辦法，只好來自己編。幸好 entware 的 wiki 頁上也有<a href="https://github.com/Entware-ng/Entware-ng/wiki/Compile-packages-from-sources">教學</a>，也是照著做就好。</p>
<p>Entware-ng 用的是 OpenWrt Buildroot，所以需要先裝好<a href="http://wiki.openwrt.org/doc/howto/buildroot.exigence#install_procedure_on_linux">它依賴的套件</a>。</p>
<p>為了不把主力機的 Arch Linux 給搞髒了，我決定用找 docker 的方式來解決。<br />
網路上可以找到一個用 arch 為底的 Dockerfile(<a href="https://github.com/jannispinter/arch-openwrt-buildroot">arch-docker-buildroot</a>)，但是實際編譯時會出先一些版本上的不相容問題，所以我還是乖乖的用 ubuntu 的 image 來做。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">FROM</span> ubuntu</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">RUN</span> apt-get update</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw">RUN</span> DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential subversion libncurses5-dev zlib1g-dev gawk gcc-multilib flex git-core gettext libssl-dev unzip python-dev python file wget sudo</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co"># 編譯時需要非 root 帳號</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">RUN</span> useradd -m openwrt &amp;&amp;\</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">echo <span class="st">&#39;openwrt ALL=NOPASSWD: ALL&#39;</span> &gt; /etc/sudoers.d/openwrt</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="kw">USER</span> openwrt</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="kw">WORKDIR</span> /home/openwrt</a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="kw">CMD</span> [<span class="st">&quot;/bin/bash&quot;</span>]</a></code></pre></div>
<p>docker 環境準備好、進入其 shell 之後<span><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle"/><span class="sidenote">我用不同的顏色來區別 docker 環境內的操作<br />
<br />
</span></span></p>
<ul>
<li><p>準備 entware 跟更新其 package feeds：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash example"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="fu">git</span> clone https://github.com/Entware-ng/Entware-ng.git</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="bu">cd</span> Entware-ng</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="fu">make</span> package/symlinks</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="fu">cp</span> configs/armv7.config .config</a></code></pre></div></li>
<li><p>安裝編譯需要 tools/toolchain，這一步驟需要很長一段時間，我就跑去打 Splatoon 的 Salmon Run 了。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash example"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="fu">make</span> -j4 tools/install</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="fu">make</span> -j4 toolchain/install</a></code></pre></div></li>
<li><p><strong>確認 .config 裡面有啟用 <code>shadowsocks-libev</code> 跟 <code>shadowsocks-libev-ss-server</code> 兩個套件</strong>，我在編的時候沒確認到這點，花了好一段時間研究為什麼編完沒有 binary 檔。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash example"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="fu">make</span> menuconfig <span class="co"># 選好 shadowsocks （Network 的 Web Servers/Proxies 底下）</span></a></code></pre></div>
<p>或是直接在 .config 加上</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash example"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="ex">CONFIG_PACKAGE_shadowsocks-libev-config</span>=m</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="ex">CONFIG_PACKAGE_shadowsocks-libev-ss-server</span>=m</a></code></pre></div></li>
<li><p>然後編譯需要的套件</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash example"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="fu">make</span> -j4 package/shadowsocks-libev/compile</a></code></pre></div></li>
</ul>
<p>編譯完之後會在 bin 下面找到對應的 .ipkg 檔，接著就是傳到 NAS 上</p>
<ul>
<li><p>用 opkg 安裝：</p>
<pre><code>opkg install shadowsocks-libev-config_3.0.6-2_armv7soft.ipk
opkg install shadowsocks-libev-ss-server_3.0.6-2_armv7soft.ipk</code></pre></li>
<li><p>設定好 <code>/opt/etc/shadowsocks.json</code> 跟 <code>/opt/etc/init.d/S22shadowsocks</code>：</p>
<pre><code>sed -ir &#39;s/PROCS=ss-local/PROCS=ss-server/&#39; /opt/etc/init.d/S22shadowsocks</code></pre></li>
<li><p>確認 shadowsocks-libev 可以啟動</p>
<pre><code>/opt/etc/init.d/S22shadowsocks start</code></pre></li>
</ul>
<p>設定好 router 的 NAT，然後用手機之類的測試會動之後，收工。</p>
</section>
</section>]]></description>
    <pubDate>Sun, 27 Aug 2017 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-08-27-ds216j-shadowsocks.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>[en] Notes on Thinkpad X1 Carbon 2017 + Arch Linux</title>
    <link>https://op8867555.github.io/posts/2017-06-11-X1C5-notes.html</link>
    <description><![CDATA[<section id="changelogs" class="level3">
<h3>changelogs</h3>
<ul>
<li>08/22 update kernel to 4.12; add a WWAN section.</li>
<li>07/22 rewrite the post in English, remove some outdated information.</li>
</ul>
</section>
<section id="quick-summary" class="level1">
<h1>Quick Summary</h1>
<p>I got a Thinkpad X1 Carbon 5th Gen (X1C5) and running Arch Linux (4.12) on it.</p>
<p>Most stuff works out of box,</p>
<ul>
<li>wifi</li>
<li>backlit keyboard</li>
<li>LEDs on keyboard (caps lock/mute/mic mute)</li>
<li><a href="#trackpoint">TrackPoint</a> - slow speed but works.</li>
<li><a href="#trackpad">TrackPad</a> - not so precise but works.</li>
<li>Thunderbolt 3 - USB-C to HDMI / USB-C Hub works.</li>
<li>Bluetooth - works with a FC30 game controller.</li>
<li><a href="#wwan">WWAN</a> - works with ModemManager.</li>
</ul>
<p>I haven’t tried,</p>
<ul>
<li>micro SD reader</li>
<li>mini-Ethernet - I don’t have the adapter.</li>
<li>hibernation - I don’t setup a swap partition.</li>
</ul>
</section>
<section id="topics" class="level1">
<h1>Topics</h1>
<section id="trackpoint" class="level2">
<h2>TrackPoint</h2>
<section id="alps-or-elantech" class="level3">
<h3>ALPS or Elantech</h3>
<p>X1C5 comes with two versions of TrackPoint: ALPS and Elantech<span><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="sidenote"><a href="https://patchwork.kernel.org/patch/9768231/" class="uri">https://patchwork.kernel.org/patch/9768231/</a><br />
<br />
</span></span>.</p>
<p>I confirmed mine has an Elantech one using <a href="http://pcsupport.lenovo.com/tw/zh/products/laptops-and-netbooks/thinkpad-x-series-laptops/thinkpad-x1-carbon-type-20hr-20hq/downloads/ds122148">TrackPointDetect.exe</a>.</p>
<pre><code>TouchPad-Flash Utility
2017-06-08 20:42:27
Command Line: &quot;C:\Users\alexlu\Desktop\FW_Updater_1.0.0.9\TrackPointDetect.exe&quot; 
OS: 64-bit
Pst Vendor : Elan
[ERROR]: This TrackPoint is Elan (ID:03)</code></pre>
</section>
<section id="issues" class="level3">
<h3>Issues</h3>
<ul>
<li><p>Recognized as a “PS/2 Generic Mouse”<br />
⇒ No palm-detection during trackpoint use</p></li>
<li><p>Since kernel driver doesn’t support the new trackpoint, both of sensitivity and speed aren’t adjustable.<br />
⇒ The default speed/sensitivity is too slow to use.</p></li>
</ul>
</section>
<section id="mark-it-as-a-pointing-stick" class="level3">
<h3>Mark it as a pointing stick</h3>
<p>I found I can making libinput treat the “PS/2 Generic Mouse” as a trackpoint using a custom udev hwdb entry.</p>
<p><em>Note: this should not be used anymore once trackpoint gets kernel driver supports</em></p>
<pre><code>evdev:name:PS/2 Generic Mouse:dmi:*svnLENOVO*:pvrThinkPadX1Carbon5th*
  ID_INPUT_POINTINGSTICK=1</code></pre>
</section>
<section id="better-trackpoint-acceleration" class="level3">
<h3>Better TrackPoint Acceleration</h3>
<p>There is a <a href="https://bugs.freedesktop.org/show_bug.cgi?id=91369#c48">patch</a> which solves speed issue.</p>
<p>I get my trackpoint much usable by setting up:</p>
<ul>
<li><code>LIBINPUT_ATTR_TRACKPOINT_RANGE=10</code> in hwdb</li>
<li><code>xinput set-prop &quot;PS/2 Generic Mouse&quot; &quot;libinput Accel Speed&quot; -0.25</code> in my .xinitrc</li>
</ul>
</section>
</section>
<section id="trackpad" class="level2">
<h2>TrackPad</h2>
<p>The trackpad is <ins>able to</ins> use rmi4 over smbus for now(4.12).</p>
<p>Turn it on by creating a <code>psmouse.conf</code> in <code>/etc/modprobe.d/</code></p>
<pre><code>options psmouse synaptics_intertouch=1</code></pre>
<section id="palm-detection" class="level3">
<h3>Palm Detection</h3>
<ul>
<li>pressure-based palm-detection works great (libinput ≥ 1.8)</li>
<li>palm-detection during trackpoint use requires <a href="#mark-it-as-a-pointing-stick">mark it as a pointing stick</a>.</li>
</ul>
</section>
</section>
<section id="new-hotkeys" class="level2">
<h2>New Hotkeys</h2>
<p>Before linux-4.12, You needs <a href="https://patchwork.kernel.org/patch/9596129/">these</a> <a href="https://patchwork.kernel.org/patch/9596131/">patches</a> to get these buttons works.</p>
</section>
<section id="fingerprint-reader" class="level2">
<h2>Fingerprint Reader</h2>
<p>X1C5 have a Validity Sensor 138a:0097. There is no driver for it.</p>
<p>Furthermore,</p>
<ul>
<li><a href="https://github.com/nmikhailov/Validity90">Validity90</a> - an open source reverse engineered driver (WIP).</li>
<li><a href="https://bugs.freedesktop.org/show_bug.cgi?id=94536">a bug report of libfprint</a></li>
</ul>
</section>
<section id="wwan" class="level2">
<h2>WWAN</h2>
<p>X1C5 (WWAN) comes with a Sierra EM7455 LTE Modem (1199:9079).</p>
<p>It works out of box using latest ModemManager.</p>
<section id="connecting-without-networkmanager" class="level3">
<h3>connecting without NetworkManager</h3>
<p>I’m wondering if there is a better way to do this…</p>
<section id="connecting" class="level4">
<h4>connecting</h4>
<ul>
<li>find modem id: <code>mmcli -L</code></li>
<li>connect: <code>mmcli -m $MODEM --simple-connect=&quot;apn=internet&quot;</code></li>
<li>after a successful connect, find ip from bearer info
<ul>
<li><code>mmcli -m $MODEM</code> will show bearer id</li>
<li><code>mmcli -b $BEARER_ID</code> will show ip/gateway/broadcast…</li>
</ul></li>
<li>bring up the interface <code>ip link set $INTERFACE up</code></li>
<li>assign a static IP: <code>ip addr add $IP_ADDR/$PREFIX broadcast $BROADCAST_ADDR dev $IFACE</code></li>
<li>add a route: <code>ip route add default via $GATEWAY</code></li>
</ul>
</section>
<section id="disconnecting" class="level4">
<h4>disconnecting</h4>
<ul>
<li>bring the interface down</li>
<li>remove route for it</li>
<li>remove static IP assignment</li>
<li><code>mmcli -m $MODEM --simple-disconnect</code></li>
</ul>
</section>
</section>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li><a href="https://gist.github.com/gdamjan/141bb0def5f80257fae2b233ec16f3c2">gdamjan’s Note</a></li>
<li><a href="http://fredrik.wendt.se/2017/04/26/lenovo-thinkpad-x1-carbon-5th-generation/">Fredrik’s Note</a></li>
<li><a href="https://forums.lenovo.com/t5/forums/v3_1/forumtopicpage/board-id/tp02_en/thread-id/75464/page/29">discussion about TrackPad</a></li>
</ul>
</section>]]></description>
    <pubDate>Tue, 22 Aug 2017 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-06-11-X1C5-notes.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>
<item>
    <title>用 VEGA 資料視覺化</title>
    <link>https://op8867555.github.io/posts/2017-08-11-vega.html</link>
    <description><![CDATA[<section id="tldr" class="level3">
<h3>tl;dr</h3>
<p><a href="https://vega.github.io/vega/">Vega</a> 是一個種描述互動視覺化的文法(JSON 規格)，相對於低階的 <a href="https://d3js.org/">d3.js</a>，提供了一個不用碰太多 JavaScript 就能編寫圖表的高階宣告式語法。這篇文章簡述 <a href="https://vega.github.io/vega/">Vega</a> 的概念，然後以 COSCUP 2017 的議程表為題寫了一個 tutorial（<a href="https://vega.github.io/editor/#/gist/vega/op8867555/5af6189b957373bf0ff9969c8e3d426a">完成品</a>）。</p>
<p>另外，如果只有簡單的資料（csv, json…等），又只需要基本的幾種圖，可以考慮使用 <a href="https://vega.github.io/vega-lite/">vega-lite</a> 這個比 vega 還要高階的語言來做。</p>
</section>
<section id="vega" class="level1">
<h1>VEGA</h1>
<blockquote>
<p>Vega is a visualization grammar, a declarative language for creating, saving, and sharing interactive visualization designs. With Vega, you can describe the visual appearance and interactive behavior of a visualization in a JSON format, and generate web-based views using Canvas or SVG.</p>
</blockquote>
<p><a href="https://vega.github.io/vega/">Vega</a> 是 Washington Interactive Data Lab 的另一個專案(就是那個做 <a href="https://d3js.org/">d3.js</a> 的 IDL)，提出了一個 JSON 格式的文法，用來描述互動式的視覺化圖表，也一併給了 JavaScript 的 Runtime 實作。(背後很理所當然的用了 <a href="https://d3js.org/">d3.js</a> 作為 backend)</p>
<section id="為什麼不用-d3-就好" class="level2">
<h2>為什麼不用 d3 就好</h2>
<p>雖然不太一樣，但是可以先看看兩者實作 bar chart 的方式： <a href="https://bl.ocks.org/mbostock/3885304">d3</a>, <a href="https://vega.github.io/vega/examples/bar-chart/">vega</a>。</p>
<p>可以看到幾點：</p>
<ul>
<li>vega 的寫法少了很多來自 js 語法的雜訊，<br />
也不用讓變數名稱佔掉大腦可貴的記憶空間<span><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle"/><span class="sidenote"><a href="https://www.kernel.org/doc/html/v4.10/process/coding-style.html#functions" class="uri">https://www.kernel.org/doc/html/v4.10/process/coding-style.html#functions</a><br />
<br />
</span></span></li>
<li>vega 用了一個 json 敘述來描述視覺化，<br />
但是 d3.js 的版本需要從 html/svg/canvas 等低階的實作細節開始考慮</li>
<li>比起 js ， JSON 格式更好自動生成，也就是更好串接在其他應用</li>
</ul>
<p>Vega 團隊<a href="https://github.com/vega/vega/wiki/Vega-and-D3">有講明</a> Vega 的目的並不是要取代 d3.js ，而是在 d3.js 的基礎上，建立更高層度的視覺化。</p>
</section>
<section id="長什麼樣子" class="level2">
<h2>長什麼樣子</h2>
<p>官網給的一個 bar chart 的範例長的像<a href="https://vega.github.io/vega/examples/bar-chart/">這樣</a>，可以發現幾乎看不到程式碼。</p>
<p>下面這個是從 <a href="https://vega.github.io/vega/docs/specification/">specification</a> 抄來的基本款 outline</p>
<ul>
<li>上半部是除了 <code>$schema</code> 之外，是一些關於整張圖的 top-level 設定</li>
<li>下半部 <code class="sourceCode javascript">[]</code> 分別還需要填入適當的內容。</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="dt">&quot;$schema&quot;</span><span class="fu">:</span> <span class="st">&quot;https://vega.github.io/schema/vega/v3.0.json&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;A specification outline example.&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="dt">&quot;width&quot;</span><span class="fu">:</span> <span class="dv">500</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="dt">&quot;height&quot;</span><span class="fu">:</span> <span class="dv">200</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="dt">&quot;padding&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  <span class="dt">&quot;autosize&quot;</span><span class="fu">:</span> <span class="st">&quot;pad&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  <span class="dt">&quot;signals&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  <span class="dt">&quot;scales&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  <span class="dt">&quot;projections&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">  <span class="dt">&quot;axes&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">  <span class="dt">&quot;legends&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">  <span class="dt">&quot;marks&quot;</span><span class="fu">:</span> <span class="ot">[]</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="fu">}</span></a></code></pre></div>
<ul>
<li><code>signals</code> 提供一個 reactive 的方法來做互動事件： 滑鼠移動、內建的按鈕、範圍選擇器之類的</li>
<li><code>data</code> 用來載入、parse、轉換，一些簡單的資料處理 (filter, aggregation 之類的都可以在這裡做掉)。</li>
<li><code>scales</code> 用來映射資料的 domain 跟 輸出的 range (XY 座標/ 顏色等)。</li>
<li><code>projections</code> 用來將經緯度投影到座標平面。</li>
<li><code>axes</code> 可以指定圖的的座標軸的位置、刻度。</li>
<li><code>legends</code> 是圖的圖例。</li>
<li><code>marks</code> 用來畫出折線、面積、矩形…等所有表現資料的部份，是整張圖核心的部份。</li>
</ul>
<p>畫圖所需要的元素 VEGA 團隊都適當的設計了出來，剩下的就是使用者依照需求填空了。</p>
</section>
<section id="如何開始" class="level2">
<h2>如何開始</h2>
<p>如果想要開始使用，可以先看官方網站上的兩個 tutorials 寫的簡單好懂（當然還是需要看 documentation 就是了）</p>
<ul>
<li><a href="https://vega.github.io/vega/tutorials/bar-chart/">Let’s Make A Bar Chart</a> 介紹了最基本的幾個元素: data, scale, axes, marks, signals</li>
<li><a href="https://vega.github.io/vega/tutorials/airports/">Mapping Airport Connections</a> 進一步應用了 data transform, projections, signals</li>
</ul>
<p>除此之外，官方網站上也有一個線上的 WYSIWYG 編輯器： <a href="https://vega.github.io/editor">Vega Editor</a>，裡面有很多範例可以 <del>塗塗改改</del> 參考。</p>
<p>剩下的就是讀<a href="https://vega.github.io/vega/docs/">文件</a>啦。</p>
</section>
</section>
<section id="tutorial" class="level1">
<h1>tutorial</h1>
<p>因為這次 COSCUP 2017 官網最早沒有釋出時間線形式的議程表，但是有給足自幹需要的資料， 就發現<a href="https://docs.google.com/spreadsheets/d/1gVQtWEqOZLsDtk1j-_TrPqq_nWN5VcTtWLpme3yl3Zc/edit#gid=98295178">大家都自幹了一份</a>，於是我就用 vega 也兜了一個簡單的版本，也就順便以此為原形，寫了這篇 tutorial。</p>
<p><em>這篇 tutorial 會簡述怎麼從零開始到做出一個這樣議程表</em></p>
<p><img src="http://i.imgur.com/HUAwF8k.png" class="half-page center" /></p>
<section id="準備" class="level2">
<h2>準備</h2>
<p>打開 <a href="https://vega.github.io/editor">Vega Editor</a>，就可以開始了。</p>
</section>
<section id="top-level" class="level2">
<h2>top-level</h2>
<p>首先要先有個最簡單的雛型，宣告 schema 版本、圖的大小等</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">// vg.json</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="st">&quot;$schema&quot;</span><span class="op">:</span> <span class="st">&quot;https://vega.github.io/schema/vega/v3.0.json&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="st">&quot;width&quot;</span><span class="op">:</span> <span class="dv">480</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="st">&quot;height&quot;</span><span class="op">:</span> <span class="dv">1600</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="st">&quot;padding&quot;</span><span class="op">:</span> <span class="dv">50</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="op">}</span></a></code></pre></div>
</section>
<section id="data" class="level2">
<h2>Data</h2>
<p>這次的資料是 COSCUP 2017 官網所使用的 <a href="https://coscup.org/2017-assets/json/submissions.json">submissions.json</a>，是一個 array of records ，如下：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">// submissions.json</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">[</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">// 我隨便節錄了一個議程，兩天所有的議程都在這個 array 裡面</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="st">&quot;room&quot;</span><span class="op">:</span> <span class="st">&quot;202&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="st">&quot;community&quot;</span><span class="op">:</span> <span class="st">&quot;Chinese 中文&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    <span class="st">&quot;subject&quot;</span><span class="op">:</span> <span class="st">&quot;Unicode 不是年年更新嗎，2017 怎麼還在缺字？&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="st">&quot;summary&quot;</span><span class="op">:</span> <span class="st">&quot;維基文庫是維基媒體基金會所屬計畫中有關原始文獻典藏的網站，而中文的維基文庫因此遇到其他維基計畫不曾遇到的問題–暴量的古籍缺字。台灣的維基分會在經手吳守禮國臺對 照活用辭典的現代數位化之計畫中，也遇到了嚴重的缺字問題，好在現在開源動態組字技術已經發展成熟，可以整合到維基網站裡，本議題將分享該專案運用此新式缺字處理技術的點滴、目前瓶頸、未來的展望。&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    <span class="st">&quot;start&quot;</span><span class="op">:</span> <span class="st">&quot;2017-08-05T16:20:00+08:00&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    <span class="st">&quot;end&quot;</span><span class="op">:</span> <span class="st">&quot;2017-08-05T17:00:00+08:00&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">    <span class="st">&quot;original_speakerpic&quot;</span><span class="op">:</span> <span class="st">&quot;http://imgur.com/q0j6fda&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12">    <span class="st">&quot;lang&quot;</span><span class="op">:</span> <span class="st">&quot;ZH&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13">    <span class="st">&quot;speaker&quot;</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">      <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;張正一&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15">      <span class="st">&quot;avatar&quot;</span><span class="op">:</span> <span class="st">&quot;https://coscup.org/2017-assets/images/program/202-2017-08-05T1515.jpg&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">      <span class="st">&quot;bio&quot;</span><span class="op">:</span> <span class="st">&quot;維基協會理事，維基吳守禮台語辭典現代數位化計畫 PM，動態組字技術開發長期參與者&quot;</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  <span class="op">},</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">// 還有更多...</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">]</a></code></pre></div>
<p>Vega 支援讀取 array of records 的資料，我們可以直接將他讀進來，然後順便對時間欄位做 parse ：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">// vg.json</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="op">{</span> <span class="co">// 前略</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="st">&quot;data&quot;</span><span class="op">:</span>[</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    <span class="op">{</span> <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;table&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">       <span class="st">&quot;url&quot;</span><span class="op">:</span> <span class="st">&quot;https://coscup.org/2017-assets/json/submissions.json&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">       <span class="st">&quot;format&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;type&quot;</span><span class="op">:</span><span class="st">&quot;json&quot;</span><span class="op">,</span> <span class="st">&quot;parse&quot;</span><span class="op">:{</span><span class="st">&quot;start&quot;</span><span class="op">:</span><span class="st">&quot;date&quot;</span><span class="op">,</span> <span class="st">&quot;end&quot;</span><span class="op">:</span> <span class="st">&quot;date&quot;</span><span class="op">}}</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  ]</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="op">}</span></a></code></pre></div>
<p>如果用的是 Vega Editor 的話，可以打開 developer console (chrome 的話按 <key>Ctrl</key> + <key>Shift</key> + <key>J</key>) 執行：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="va">VEGA_DEBUG</span>.<span class="va">view</span>.<span class="at">data</span>(<span class="st">&#39;table&#39;</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">// (141) [Object, Object, Object, Object, Object, Object, Object, Object, Object, Object, …]</span></a></code></pre></div>
<p>可以觀察到資料有正確載入。</p>
</section>
<section id="scale-axes" class="level2">
<h2>Scale, Axes</h2>
<p>載入資料之後、把圖畫出來之前，需要先將資料的範圍映射圖的X/Y座標：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">// vg.json 的片段</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="st">&quot;scales&quot;</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    <span class="op">{</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">      <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;xscale&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">      <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;band&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">      <span class="st">&quot;domain&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;data&quot;</span><span class="op">:</span> <span class="st">&quot;table&quot;</span><span class="op">,</span> <span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;room&quot;</span><span class="op">,</span> <span class="st">&quot;sort&quot;</span><span class="op">:</span> <span class="kw">true</span><span class="op">},</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">      <span class="st">&quot;range&quot;</span><span class="op">:</span> <span class="st">&quot;width&quot;</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="op">{</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">      <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;yscale&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">      <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;time&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">      <span class="st">&quot;domain&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;data&quot;</span><span class="op">:</span> <span class="st">&quot;table&quot;</span><span class="op">,</span> <span class="st">&quot;fields&quot;</span><span class="op">:</span> [<span class="st">&quot;start&quot;</span><span class="op">,</span> <span class="st">&quot;end&quot;</span>]<span class="op">},</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">      <span class="st">&quot;range&quot;</span><span class="op">:</span> <span class="st">&quot;height&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">      <span class="st">&quot;reverse&quot;</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16">  ]</a></code></pre></div>
<p>每個 scale 都要有對應的名字 <code>name</code> 跟類型 <code>type</code> ，這邊我分別定義了：</p>
<p><code>xscale</code></p>
<ul>
<li><code>band</code> 可以做出 categorical 分段的效果(想像一下 bar chart，看一下<a href="https://vega.github.io/vega/docs/scales/#band">這張圖</a>)</li>
<li><code>sort</code> 好讓場地依照順序顯示</li>
<li><code>range</code> 設定成 <code>width</code> 指的是 top-level 的設定</li>
</ul>
<p><code>yscale</code></p>
<ul>
<li><code>time</code> 告訴 vega 我用的資料是個時間</li>
<li><code>fields</code> 指定 <code>domain</code> 的最小最大值來自哪個欄位</li>
<li><code>reverse</code> 用來反轉軸的大小，讓先發生的有比較高的值，顯示在圖的上方</li>
</ul>
<p>我們可以畫幾個座標軸（使用前面定義的scale）來觀察：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co">// vg.json 的片段</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  <span class="st">&quot;axes&quot;</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    <span class="op">{</span> <span class="st">&quot;orient&quot;</span><span class="op">:</span> <span class="st">&quot;top&quot;</span><span class="op">,</span> <span class="st">&quot;scale&quot;</span><span class="op">:</span> <span class="st">&quot;xscale&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    <span class="op">{</span> <span class="st">&quot;orient&quot;</span><span class="op">:</span> <span class="st">&quot;bottom&quot;</span><span class="op">,</span> <span class="st">&quot;scale&quot;</span><span class="op">:</span> <span class="st">&quot;xscale&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    <span class="op">{</span> <span class="st">&quot;orient&quot;</span><span class="op">:</span> <span class="st">&quot;left&quot;</span><span class="op">,</span> <span class="st">&quot;scale&quot;</span><span class="op">:</span> <span class="st">&quot;yscale&quot;</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  ]</a></code></pre></div>
</section>
<section id="marks" class="level2">
<h2>Marks</h2>
<p>我希望將每個議程用方塊的方式畫出來，做出時間表的的效果。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">// vg.json 的片段</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="st">&quot;marks&quot;</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">    <span class="op">{</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">      <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;rect&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">      <span class="st">&quot;from&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;data&quot;</span><span class="op">:</span><span class="st">&quot;table&quot;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">      <span class="st">&quot;encode&quot;</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">        <span class="st">&quot;update&quot;</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">          <span class="st">&quot;xc&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;scale&quot;</span><span class="op">:</span> <span class="st">&quot;xscale&quot;</span><span class="op">,</span> <span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;room&quot;</span><span class="op">,</span> <span class="st">&quot;band&quot;</span><span class="op">:</span><span class="fl">0.5</span><span class="op">},</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">          <span class="st">&quot;width&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;scale&quot;</span><span class="op">:</span> <span class="st">&quot;xscale&quot;</span><span class="op">,</span> <span class="st">&quot;band&quot;</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">},</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">          <span class="st">&quot;y&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;scale&quot;</span><span class="op">:</span> <span class="st">&quot;yscale&quot;</span><span class="op">,</span> <span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;start&quot;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">          <span class="st">&quot;y2&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;scale&quot;</span><span class="op">:</span> <span class="st">&quot;yscale&quot;</span><span class="op">,</span> <span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;end&quot;</span><span class="op">}</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">      <span class="op">}</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">  ]</a></code></pre></div>
<ul>
<li>每個 mark 都要有對應的 <code>type</code>，這邊選用方塊(<code>rect</code>)</li>
<li>用 <code>from</code> 來指定資料來源</li>
</ul>
<p><code>encode</code> 的部份用來指定畫圖時的參數，建議先看一下<a href="https://vega.github.io/vega/docs/marks/">文件</a> 跟 <a href="https://bost.ocks.org/mike/join/">Thinking with Joins</a></p>
<ul>
<li><code>xc</code> 用來指定 整個方塊的中心座標，<code>band</code> 是為了調整方塊的位置，向右移動半個 band</li>
<li><code>width</code> 用半個 <code>band</code></li>
<li><code>y</code>, <code>y2</code> 指定方塊的上界跟下界，感謝 scale ，我們可以直接指定 <code>start</code> 跟 <code>end</code> 這兩個時間欄位</li>
</ul>
<p>看起來不糟，不過上點顏色應該會好看點。我用議程屬於的社群(<code>community</code>) 來上色。</p>
<ul>
<li>先建立一個 scale 從社群類型映射到顏色</li>
<li>在 marks 裡面使用這個 scale</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co">// vg.json 的片段，scale 底下</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">    <span class="op">{</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">      <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;color&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">      <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;ordinal&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">      <span class="st">&quot;domain&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;data&quot;</span><span class="op">:</span> <span class="st">&quot;table&quot;</span><span class="op">,</span> <span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;community&quot;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">      <span class="st">&quot;range&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;scheme&quot;</span><span class="op">:</span> <span class="st">&quot;category20&quot;</span><span class="op">}</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    <span class="op">}</span></a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">// vg.json 的片段，marks[0][&quot;encode&quot;] 底下</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="st">&quot;enter&quot;</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">      <span class="st">&quot;fill&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;scale&quot;</span><span class="op">:</span> <span class="st">&quot;color&quot;</span><span class="op">,</span> <span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;community&quot;</span><span class="op">}</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="op">}</span></a></code></pre></div>
<p>另外，可以用 <code>tooltip</code> 屬性來顯示議程的主題：</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co">// vg.json 的片段，marks[0][&quot;encode&quot;][&quot;enter&quot;] 裡面</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="st">&quot;tooltip&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;subject&quot;</span><span class="op">}</span></a></code></pre></div>
</section>
<section id="transform" class="level2">
<h2>Transform</h2>
<p>可以看到第一天議程結束到第二天議程結束有一大段空閒，可以用 transform 的 filter 來選擇只用哪一部分的資料。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">// vg.json 的片段，data 底下</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">&quot;transform&quot;</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  <span class="op">{</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;filter&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">    <span class="st">&quot;expr&quot;</span><span class="op">:</span> <span class="st">&quot;datum.start &gt;= datetime(2017, 8-1, 5) &amp;&amp; datum.end &lt; datetime(2017, 8-1, 5+1)&quot;</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">]</a></code></pre></div>
<p><code>expr</code> 吃一個 vega 精簡過的 javascript subset，用來給 <code>filter</code> 決定保留與否。</p>
</section>
<section id="signals" class="level2">
<h2>Signals</h2>
<p>我不會永遠只想看其中一天，也不希望要看隔天的議程還要做修改這份 vega json。好在 vega 提供了一些方便的 signal，我這邊選用了他現成的 radio input：會在圖上面加上一個互動的 radio button，然後綁定成一個 signal。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co">// vg.json 的片段</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">&quot;signals&quot;</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">    <span class="op">{</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">      <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;day&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">      <span class="st">&quot;value&quot;</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">      <span class="st">&quot;bind&quot;</span><span class="op">:</span> <span class="op">{</span><span class="st">&quot;input&quot;</span><span class="op">:</span> <span class="st">&quot;radio&quot;</span><span class="op">,</span> <span class="st">&quot;options&quot;</span><span class="op">:</span> [<span class="dv">5</span><span class="op">,</span> <span class="dv">6</span>]<span class="op">}</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">]</a></code></pre></div>
<p>綁定過的 signal 可以作為 <code>expr</code> 內的變數使用</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co">// vg.json 的片段，修改 data[&quot;transform&quot;][0][&quot;expr&quot;]</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">&quot;expr&quot;</span><span class="op">:</span> <span class="st">&quot;datum.start &gt;= datetime(2017, 8-1, day) &amp;&amp; datum.end &lt; datetime(2017, 8-1, day)&quot;</span></a></code></pre></div>
</section>
<section id="完成" class="level2">
<h2>完成</h2>
<p>一個簡單的<a href="https://vega.github.io/editor/#/gist/vega/op8867555/5af6189b957373bf0ff9969c8e3d426a">議程時間表</a>就完成啦！當然還有很多可以增加/改進的地方，像是：</p>
<ul>
<li>顯示更多情報：講者、議程摘要…</li>
<li>讓圖更漂亮：調整滑鼠 hover 時的 style …</li>
<li>加上 Scale Break ，直接省去切換兩天的動作</li>
<li>想辦法支援行動瀏覽器，手機版的 chrome 就不支援顯示 tooltip</li>
<li>…</li>
</ul>
</section>
</section>
<section id="總結" class="level1">
<h1>總結</h1>
<p>我最後的成果放在<a href="https://op8867555.github.io/coscup2017-submissions/index.html">這邊</a>，雖然不完美，但是也讓我在很短的時間內完成了一個堪用的成品。</p>
<p><em>利用 Vega 這個工具，可以迅速得做出簡單好讀寫（相對於 d3.js），但又不失彈性的視覺化成果。</em></p>
<p>題外話，雖然 JSON 還算是好讀寫，但是實際還是不太適合人類直接編寫，要的話用 YAML 或是再幹一個 DSL 可能會比較方便。</p>
</section>]]></description>
    <pubDate>Fri, 11 Aug 2017 00:00:00 UT</pubDate>
    <guid>https://op8867555.github.io/posts/2017-08-11-vega.html</guid>
    <dc:creator>Alex Lu</dc:creator>
</item>

    </channel>
</rss>
