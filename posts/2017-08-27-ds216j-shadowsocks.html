<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="CLMtF1JkUEd-jPZ3RQateLLiKyn729kaOHg9Hnu_TSo" />
    <title>Alex's Blog - ç­†è¨˜ï¼š DS216j å®‰è£ shadowsocks server</title>
    <meta name="robots" content="index, follow" />
    <link rel="alternate" href="../feed.xml" title="Alex Lu's Blog" type="application/atom+xml">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue_grey-indigo.min.css" />
    <link rel="stylesheet" href="../css/default.css" />
    <link rel="stylesheet" href="../css/syntax.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script defer src="../js/toc.js"></script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-40612089-3', 'auto');
    ga('send', 'pageview');
    </script>
  </head>
  <body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-drawer ">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
          <!-- Title -->
          <span class="mdl-layout-title">Alex's Blog</span>
          <a class="mdl-navigation__link" href="../">Home</a>
          <a class="mdl-navigation__link" href="../archive.html">Archive</a>
        </div>
      </header>
      <div class="mdl-layout__drawer">
        <nav class="mdl-navigation" id="drawer">
          <a class="mdl-navigation__link" href="../">
            <i class="material-icons">home</i> Home
          </a>
          <a class="mdl-navigation__link" href="../archive.html">
            <i class="material-icons">folder</i> Archive
          </a>
        </nav>
      </div>
      <main class="mdl-layout__content">
      <div class="page-content">
        <div class="content-grid mdl-grid">
  <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
    <div class="mdl-card__title mdl-card--expand">
      <h2 class="mdl-card__title-text">ç­†è¨˜ï¼š DS216j å®‰è£ shadowsocks server</h2>
    </div>
    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
      <div>
        
        <span>August 27, 2017</span>
      </div>
      
      <div>
      <span>Tags: <a href="../tags/shadowsocks.html">shadowsocks</a>, <a href="../tags/openwrt.html">openwrt</a>, <a href="../tags/nas.html">nas</a></span>
      </div>
      
    </div>
    <div class="mdl-color-text--grey-700 mdl-card__supporting-text" id="post-body">
      <p>æœ€è¿‘è¦ªæˆšå¼„äº†å° Synology DS216j æƒ³æ‹¿ä¾†æ¶ shadowsocks çš„ serverï¼Œé€™ç¯‡æ–‡ç« ç­†è¨˜æˆ‘æ¶é€™å€‹ server æ‰€èµ°çš„è·¯ã€‚</p>
<h3 id="changelogs">changelogs</h3>
<ul>
<li>2017-10-12 ç´€éŒ„ä¸€ä¸‹ï¼Œç¾åœ¨ä¸Šæ¸¸æœ‰ç·¨å¥½çš„ package èƒ½ç”¨äº†</li>
</ul>
<h1 id="æŠ˜é¨°éç¨‹">æŠ˜é¨°éç¨‹</h1>
<p>æåˆ°åœ¨ NAS ä¸Šæ¶ shadowsocksï¼Œå¯ä»¥æŸ¥åˆ°å¾ˆå¤šç”¨ docker çš„è§£æ±ºæ–¹æ³•ï¼Œä¸éç¶²è·¯ä¸Šçš„å¹¾ç¯‡æ–‡ç« éƒ½èªªé€™å°æ©Ÿå™¨ä¸èƒ½ç”¨ dockerï¼Œæ‰€ä»¥æˆ‘ç›´æ¥å¾€ binary çš„æ–¹æ³•å‰é€²ã€‚</p>
<p>ä¸€é–‹å§‹çœ‹åˆ°çš„æ˜¯é€™ç¯‡ <a href="http://jexbat.com/2016/NAS-Shadowsocks/">Synology DS216Play å®‰è£… ShadowSocks</a>ï¼Œå¾é€™ç¯‡æ–‡ç« ä¸­å¾—å‡ºï¼š</p>
<ul>
<li>åŸä¾†æœ‰ package manager å¯ä»¥ç”¨</li>
<li>shadowsocks æœ‰ç”¨ python è·Ÿ libev çš„å¯¦ä½œå¯ä»¥é¸</li>
</ul>
<h2 id="å®‰è£package-manager">å®‰è£package manager</h2>
<p>æœè‘—å®‰è£ package manager çš„æ–¹å‘å‰é€²å¾Œæ‰¾åˆ°äº†é€™ç¯‡<a href="https://ky0n.xyz/synology-ds216j-optware-ipkg-init/">Synology DS216j Optware IPKG ä»‹ç´¹</a>ã€‚<br />
çœ‹äº†çœ‹ç™¼ç¾é€™æ˜¯ç¯‡ç¿»è­¯æ–‡ï¼Œè€ŒåŸæ–‡æœ‰äº†æ›´æ–°çš„<a href="http://jasmin.sakura.ne.jp/blog/0245">ç‰ˆæœ¬ğŸ‡¯ğŸ‡µ</a>ï¼Œç™¼ç¾åˆ°æœ‰ <a href="https://github.com/Entware-ng/Entware-ng/">entware-ng</a> é€™å€‹æ¯” ipkg æ›´æ–°çš„ package manager èƒ½ç”¨ï¼Œ è€Œä¸”å·²ç¶“æœ‰ shadowsocks çš„<a href="http://pkg.entware.net/binaries/armv7/Packages.html">å¥—ä»¶èƒ½ç”¨</a>ã€‚</p>
<h2 id="å®‰è£-entware-ng">å®‰è£ entware-ng</h2>
<p>å®‰è£çš„éç¨‹ä¸é›£ï¼Œå¤§è‡´ä¸Šå°±æ˜¯é–‹å¥½SSHã€ç…§è‘—<a href="https://github.com/Entware-ng/Entware-ng/wiki/Install-on-Synology-NAS">å…¶ wiki ä¸Šå¯«çš„æ­¥é©Ÿ</a>å°±è¡Œã€‚</p>
<p>ç­†è¨˜ä¸€ä¸‹æ­¥é©Ÿï¼š</p>
<ul>
<li><p>å»ºç«‹ä¸€å€‹å¥—ä»¶ç®¡ç†ç”¨çš„ç›®éŒ„ï¼Œå› ç‚ºéŸŒé«”æ›´æ–°æœƒæ¸… /opt ï¼Œæ‰€ä»¥è¦åœ¨å¤–é¢å»ºä¸¦ symlink å›å»ï¼š</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">mkdir</span> -p /volume1/@entware-ng/opt
<span class="fu">rm</span> -rf /opt
<span class="fu">ln</span> -sf /volume1/@entware-ng/opt /opt</code></pre></div></li>
<li><p>å®‰è£ entware</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">wget</span> -O - http://pkg.entware.net/binaries/armv7/installer/entware_install.sh <span class="kw">|</span> <span class="ex">/bin/sh</span></code></pre></div></li>
<li><p>è¨­å®šå•Ÿå‹•è…³æœ¬ï¼ˆé‡é–‹æ©Ÿæ™‚æŠŠ entware è£çš„æœå‹™ä¹Ÿå¸¶èµ·ä¾†ï¼‰<br />
ç·¨è¼¯ /usr/local/etc/rc.d/entware-startup.sh ï¼ˆæ•™å­¸ä¸Šæ²’æœ‰ï¼Œä½†æ˜¯æˆ‘æœ‰é †ä¾¿åš <code>chmod +x</code>ï¼‰</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co">#!/bin/sh</span>

<span class="kw">case</span> <span class="va">$1</span><span class="kw"> in</span>
    start<span class="kw">)</span>
    <span class="fu">mkdir</span> -p /opt
    <span class="fu">mount</span> -o bind /volume1/@entware-ng/opt /opt
    <span class="ex">/opt/etc/init.d/rc.unslung</span> start
    <span class="kw">;;</span>
    stop<span class="kw">)</span>
    <span class="kw">;;</span>
<span class="kw">esac</span></code></pre></div></li>
<li><p>åœ¨ç™»å…¥æ™‚è‡ªå‹•æŠŠ <code>/opt/bin</code> <code>/opt/sbin</code>åŠ åˆ° <code>PATH</code> è£¡é¢ï¼šåœ¨ /etc/profile å…§åŠ ä¸Šä¸€è¡Œ</p>
<pre><code>. /opt/etc/profile</code></pre></li>
</ul>
<p>è£å®Œä¹‹å¾Œå°±æ˜¯é–‹å¿ƒåœ°ä¾†è£ shadowsocks</p>
<pre><code>opkg update
opkg install shadowsocks-libev</code></pre>
<p>ä½†æ˜¯è£å®Œå»ç™¼ç¾æ²’æœ‰ <code>ss-server</code> é€™å€‹åŸ·è¡Œæª”ï¼ åŸå› ä¼¼ä¹æ˜¯å› ç‚º entware-ng æ²’æœ‰è·Ÿä¸Šæµçš„ openwrt åŒæ­¥ <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>ï¼Œè€Œä¸çŸ¥ç‚ºä½•çš„æ˜æ˜å°±æœ‰æ–°çš„ Makefile ï¼Œé™¤äº† mipsel ä»¥å¤–å»æ²’æœ‰æ–°çš„ binary package èƒ½ç”¨ã€‚</p>
<h3 id="æ›´æ–°">2017/10/12 æ›´æ–°</h3>
<p>å‰ä¸€é™£å­ entware æœ‰è·Ÿä¸Šæ¸¸åŒæ­¥éï¼Œæ‰€ä»¥ç›´æ¥å®‰è£ <code>shadowsocks-libev-ss-server</code> è·Ÿ <code>shadowsocks-libev-config</code> å°±è¡Œäº†</p>
<pre><code>opkg install shadowsocks-libev-config
opkg install shadowsocks-libev-ss-server</code></pre>
<h2 id="æ‰‹å‹•ç·¨è­¯">æ‰‹å‹•ç·¨è­¯</h2>
<p>æ²’è¾¦æ³•ï¼Œåªå¥½ä¾†è‡ªå·±ç·¨ã€‚å¹¸å¥½ entware çš„ wiki é ä¸Šä¹Ÿæœ‰<a href="https://github.com/Entware-ng/Entware-ng/wiki/Compile-packages-from-sources">æ•™å­¸</a>ï¼Œä¹Ÿæ˜¯ç…§è‘—åšå°±å¥½ã€‚</p>
<p>Entware-ng ç”¨çš„æ˜¯ OpenWrt Buildrootï¼Œæ‰€ä»¥éœ€è¦å…ˆè£å¥½<a href="http://wiki.openwrt.org/doc/howto/buildroot.exigence#install_procedure_on_linux">å®ƒä¾è³´çš„å¥—ä»¶</a>ã€‚</p>
<p>ç‚ºäº†ä¸æŠŠä¸»åŠ›æ©Ÿçš„ Arch Linux çµ¦æé«’äº†ï¼Œæˆ‘æ±ºå®šç”¨æ‰¾ docker çš„æ–¹å¼ä¾†è§£æ±ºã€‚<br />
ç¶²è·¯ä¸Šå¯ä»¥æ‰¾åˆ°ä¸€å€‹ç”¨ arch ç‚ºåº•çš„ Dockerfile(<a href="https://github.com/jannispinter/arch-openwrt-buildroot">arch-docker-buildroot</a>)ï¼Œä½†æ˜¯å¯¦éš›ç·¨è­¯æ™‚æœƒå‡ºå…ˆä¸€äº›ç‰ˆæœ¬ä¸Šçš„ä¸ç›¸å®¹å•é¡Œï¼Œæ‰€ä»¥æˆ‘é‚„æ˜¯ä¹–ä¹–çš„ç”¨ ubuntu çš„ image ä¾†åšã€‚</p>
<div class="sourceCode"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="kw">FROM</span> ubuntu
<span class="kw">RUN</span> apt-get update
<span class="kw">RUN</span> DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential subversion libncurses5-dev zlib1g-dev gawk gcc-multilib flex git-core gettext libssl-dev unzip python-dev python file wget sudo

<span class="co"># ç·¨è­¯æ™‚éœ€è¦é root å¸³è™Ÿ</span>
<span class="kw">RUN</span> useradd -m openwrt &amp;&amp;\
echo <span class="st">'openwrt ALL=NOPASSWD: ALL'</span> &gt; /etc/sudoers.d/openwrt
<span class="kw">USER</span> openwrt
<span class="kw">WORKDIR</span> /home/openwrt
<span class="kw">CMD</span> [<span class="st">&quot;/bin/bash&quot;</span>]</code></pre></div>
<p>docker ç’°å¢ƒæº–å‚™å¥½ã€é€²å…¥å…¶ shell ä¹‹å¾Œ</p>
<ul>
<li><p>æº–å‚™ entware è·Ÿæ›´æ–°å…¶ package feedsï¼š</p>
<div class="sourceCode"><pre class="sourceCode bash example"><code class="sourceCode bash"><span class="fu">git</span> clone https://github.com/Entware-ng/Entware-ng.git
<span class="bu">cd</span> Entware-ng
<span class="fu">make</span> package/symlinks
<span class="fu">cp</span> configs/armv7.config .config</code></pre></div></li>
<li><p>å®‰è£ç·¨è­¯éœ€è¦ tools/toolchainï¼Œé€™ä¸€æ­¥é©Ÿéœ€è¦å¾ˆé•·ä¸€æ®µæ™‚é–“ï¼Œæˆ‘å°±è·‘å»æ‰“ Splatoon çš„ Salmon Run äº†ã€‚</p>
<div class="sourceCode"><pre class="sourceCode bash example"><code class="sourceCode bash"><span class="fu">make</span> -j4 tools/install
<span class="fu">make</span> -j4 toolchain/install</code></pre></div></li>
<li><p><strong>ç¢ºèª .config è£¡é¢æœ‰å•Ÿç”¨ <code>shadowsocks-libev</code> è·Ÿ <code>shadowsocks-libev-ss-server</code> å…©å€‹å¥—ä»¶</strong>ï¼Œ æˆ‘åœ¨ç·¨çš„æ™‚å€™æ²’ç¢ºèªåˆ°é€™é»ï¼ŒèŠ±äº†å¥½ä¸€æ®µæ™‚é–“ç ”ç©¶ç‚ºä»€éº¼ç·¨å®Œæ²’æœ‰ binary æª”ã€‚</p>
<div class="sourceCode"><pre class="sourceCode bash example"><code class="sourceCode bash"><span class="fu">make</span> menuconfig <span class="co"># é¸å¥½ shadowsocks ï¼ˆNetwork çš„ Web Servers/Proxies åº•ä¸‹ï¼‰</span></code></pre></div>
<p>æˆ–æ˜¯ç›´æ¥åœ¨ .config åŠ ä¸Š</p>
<div class="sourceCode"><pre class="sourceCode bash example"><code class="sourceCode bash"><span class="ex">CONFIG_PACKAGE_shadowsocks-libev-config</span>=m
<span class="ex">CONFIG_PACKAGE_shadowsocks-libev-ss-server</span>=m</code></pre></div></li>
<li><p>ç„¶å¾Œç·¨è­¯éœ€è¦çš„å¥—ä»¶</p>
<div class="sourceCode"><pre class="sourceCode bash example"><code class="sourceCode bash"><span class="fu">make</span> -j4 package/shadowsocks-libev/compile</code></pre></div></li>
</ul>
<p>ç·¨è­¯å®Œä¹‹å¾Œæœƒåœ¨ bin ä¸‹é¢æ‰¾åˆ°å°æ‡‰çš„ .ipkg æª”ï¼Œæ¥è‘—å°±æ˜¯å‚³åˆ° NAS ä¸Š</p>
<ul>
<li><p>ç”¨ opkg å®‰è£ï¼š</p>
<pre><code>opkg install shadowsocks-libev-config_3.0.6-2_armv7soft.ipk
opkg install shadowsocks-libev-ss-server_3.0.6-2_armv7soft.ipk</code></pre></li>
<li><p>è¨­å®šå¥½ <code>/opt/etc/shadowsocks.json</code> è·Ÿ <code>/opt/etc/init.d/S22shadowsocks</code>ï¼š</p>
<pre><code>sed -ir 's/PROCS=ss-local/PROCS=ss-server/' /opt/etc/init.d/S22shadowsocks</code></pre></li>
<li><p>ç¢ºèª shadowsocks-libev å¯ä»¥å•Ÿå‹•</p>
<pre><code>/opt/etc/init.d/S22shadowsocks start</code></pre></li>
</ul>
<p>è¨­å®šå¥½ router çš„ NATï¼Œç„¶å¾Œç”¨æ‰‹æ©Ÿä¹‹é¡çš„æ¸¬è©¦æœƒå‹•ä¹‹å¾Œï¼Œæ”¶å·¥ã€‚</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://github.com/Entware-ng/entware-packages/commit/e3793bbbde8b907842f84731bfec292ccb069114" class="uri">https://github.com/Entware-ng/entware-packages/commit/e3793bbbde8b907842f84731bfec292ccb069114</a><a href="#fnref1">â†©</a></p></li>
</ol>
</div>
    </div>
  </div>
  <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
    <div class="mdl-card__title mdl-card--expand">
      <h2 class="mdl-card__title-text">Comments</h2>
    </div>
    <div class="mdl-color-text--grey-700 mdl-card__supporting-text" id="disqus_thread">
      <script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
var disqus_config = function () {
this.page.url = "https://op8867555.github.io/posts/2017-08-27-ds216j-shadowsocks.html";
this.page.identifier = "2017-08-27-ds216j-shadowsocks.md";
};
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://alex-lu-blog.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  </div>
</div>


      </div>
      </main>
    </div>
  </body>
</html>
