---
title: '[en] Notes on Thinkpad X1 Carbon 2017 + Arch Linux'
tags: laptop, linux
date: 2017-08-22
---

### changelogs

* 08/22 update kernel to 4.12; add a WWAN section.
* 07/22 rewrite the post in English, remove some outdated information.

# Quick Summary

I got a Thinkpad X1 Carbon 5th Gen (X1C5) and running Arch Linux (4.12) on it.

Most stuff works out of box,

  * wifi
  * backlit keyboard
  * LEDs on keyboard (caps lock/mute/mic mute)
  * [TrackPoint][] - slow speed but works.
  * [TrackPad][] - not so precise but works.
  * Thunderbolt 3 - USB-C to HDMI / USB-C Hub works.
  * Bluetooth - works with a FC30 game controller.
  * [WWAN][] - works with ModemManager.

I haven't tried,

  * micro SD reader
  * mini-Ethernet - I don't have the adapter.
  * hibernation - I don't setup a swap partition.

# Topics

## TrackPoint

### ALPS or Elantech

X1C5 comes with two versions of TrackPoint: ALPS and Elantech[^trackpoint_versions].

I confirmed mine has an Elantech one using [TrackPointDetect.exe][trackpoint_util].

    TouchPad-Flash Utility
    2017-06-08 20:42:27
    Command Line: "C:\Users\alexlu\Desktop\FW_Updater_1.0.0.9\TrackPointDetect.exe" 
    OS: 64-bit
    Pst Vendor : Elan
    [ERROR]: This TrackPoint is Elan (ID:03)

[trackpoint_util]: http://pcsupport.lenovo.com/tw/zh/products/laptops-and-netbooks/thinkpad-x-series-laptops/thinkpad-x1-carbon-type-20hr-20hq/downloads/ds122148

[^trackpoint_versions]: <https://patchwork.kernel.org/patch/9768231/>


### Issues

  * Recognized as a "PS/2 Generic Mouse"  
    ⇒ No palm-detection during trackpoint use

  * Since kernel driver doesn't support the new trackpoint, both of sensitivity and speed aren't adjustable.  
    ⇒ The default speed/sensitivity is too slow to use.

### Mark it as a pointing stick

I found I can making libinput treat the "PS/2 Generic Mouse" as a trackpoint using a custom udev hwdb entry.

*Note: this should not be used anymore once trackpoint gets kernel driver supports*

~~~~
evdev:name:PS/2 Generic Mouse:dmi:*svnLENOVO*:pvrThinkPadX1Carbon5th*
  ID_INPUT_POINTINGSTICK=1
~~~~

### Better TrackPoint Acceleration

There is a [patch][libinput-issue] which solves speed issue.

[libinput-issue]: https://bugs.freedesktop.org/show_bug.cgi?id=91369#c48

I get my trackpoint much usable by setting up:

  * `LIBINPUT_ATTR_TRACKPOINT_RANGE=10` in hwdb
  * `xinput set-prop "PS/2 Generic Mouse" "libinput Accel Speed" -0.25` in my .xinitrc


## TrackPad

The trackpad is <ins>able to</ins> use rmi4 over smbus for now(4.12).

Turn it on by creating a `psmouse.conf` in `/etc/modprobe.d/`

    options psmouse synaptics_intertouch=1

### Palm Detection

  * pressure-based palm-detection works great (libinput ≥ 1.8)
  * palm-detection during trackpoint use requires [mark it as a pointing stick][].

## New Hotkeys

Before linux-4.12, You needs [these][hotkey1] [patches][hotkey2] to get these buttons works.

[hotkey1]: https://patchwork.kernel.org/patch/9596129/
[hotkey2]: https://patchwork.kernel.org/patch/9596131/

## Fingerprint Reader

X1C5 have a Validity Sensor 138a:0097. There is no driver for it.

Furthermore,

  * [Validity90](https://github.com/nmikhailov/Validity90) - an open source reverse engineered driver (WIP).
  * [a bug report of libfprint](https://bugs.freedesktop.org/show_bug.cgi?id=94536)

## WWAN

X1C5 (WWAN) comes with a Sierra EM7455 LTE Modem (1199:9079).

It works out of box using latest ModemManager.

### connecting without NetworkManager

I'm wondering if there is a better way to do this...

#### connecting

  * find modem id: `mmcli -L`
  * connect: `mmcli -m $MODEM --simple-connect="apn=internet"`
  * after a successful connect, find ip from bearer info
      * `mmcli -m $MODEM` will show bearer id
      * `mmcli -b $BEARER_ID` will show ip/gateway/broadcast...
  * bring up the interface `ip link set $INTERFACE up`
  * assign a static IP: `ip addr add $IP_ADDR/$PREFIX broadcast $BROADCAST_ADDR dev $IFACE`
  * add a route: `ip route add default via $GATEWAY`

#### disconnecting

  * bring the interface down
  * remove route for it
  * remove static IP assignment
  * `mmcli -m $MODEM --simple-disconnect`


# References

* [gdamjan's Note](https://gist.github.com/gdamjan/141bb0def5f80257fae2b233ec16f3c2)
* [Fredrik's Note](http://fredrik.wendt.se/2017/04/26/lenovo-thinkpad-x1-carbon-5th-generation/)
* [discussion about TrackPad](https://forums.lenovo.com/t5/forums/v3_1/forumtopicpage/board-id/tp02_en/thread-id/75464/page/29)
